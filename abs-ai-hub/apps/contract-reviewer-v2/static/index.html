<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Reviewer v2 - Professional AI Contract Analysis</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- ABS Unified Framework -->
    <script src="/static/framework-config.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 font-sans" x-data="contractReviewer" x-init="init()" x-cloak>
    <!-- Main Content -->
    <!-- Main Navigation Tabs -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex space-x-8">
            <button @click="mainTab = 'documents'" 
                    :class="mainTab === 'documents' ? 'border-blue-500 text-blue-600 border-b-2' : 'border-transparent text-gray-500 hover:text-gray-700'"
                    class="px-1 py-2 text-sm font-medium border-b-2 transition-colors">
                <i class="fas fa-file-alt mr-2"></i>Document Review
            </button>
            <button @click="mainTab = 'history'" 
                    :class="mainTab === 'history' ? 'border-blue-500 text-blue-600 border-b-2' : 'border-transparent text-gray-500 hover:text-gray-700'"
                    class="px-1 py-2 text-sm font-medium border-b-2 transition-colors">
                <i class="fas fa-history mr-2"></i>Review History
            </button>
        </div>
    </div>

    <!-- Document Review Tab -->
    <div x-show="mainTab === 'documents'" class="flex h-screen pt-16">
        <!-- Left Panel: Document Navigation -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Upload Section -->
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-upload mr-2"></i>Document Upload
                </h3>
                
                <div @click="$refs.fileInput.click()"
                     @dragover.prevent="isDragOver = true"
                     @dragleave.prevent="isDragOver = false"
                     @drop.prevent="handleFileDrop($event)"
                     class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-all"
                     :class="isDragOver ? 'border-blue-500 bg-blue-50' : 'border-gray-300'">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">Drop files here or click to upload</p>
                    <p class="text-sm text-gray-500">Supports PDF and DOCX files</p>
                    <input type="file" x-ref="fileInput" @change="handleFileSelect($event)" 
                           accept=".pdf,.docx" class="hidden" multiple>
                </div>
                
                <!-- Upload Progress -->
                <div x-show="uploadProgress > 0" x-transition class="mt-4">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                             :style="`width: ${uploadProgress}%`"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1" x-text="uploadStatus"></p>
                </div>
            </div>

            <!-- Document List -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-folder mr-2"></i>Documents
                        <i x-show="isLoadingDocuments" class="fas fa-spinner fa-spin ml-2 text-blue-500"></i>
                    </h3>
                    <div class="flex items-center space-x-2" x-show="totalDocuments > 0">
                        <span class="text-sm text-gray-500">
                            <span x-text="(documents || []).length"></span>/<span x-text="totalDocuments"></span>
                        </span>
                        <span x-show="documentsWithErrors.length > 0" class="text-sm text-orange-600">
                            (<span x-text="documentsWithErrors.length"></span> with errors)
                        </span>
                    </div>
                </div>
                
                <!-- Search Box -->
                <div class="mb-4">
                    <div class="relative">
                        <input x-model="searchQuery" 
                               @input="debounceSearch()"
                               @keydown.enter="performSearch()"
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Search documents semantically...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <button x-show="searchQuery" 
                                @click="clearSearch()"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Similarity Threshold Slider -->
                    <div class="mt-3 flex items-center space-x-3">
                        <label class="text-xs text-gray-600 whitespace-nowrap">Similarity:</label>
                        <input type="range" 
                               x-model="searchScoreThreshold"
                               min="0.0" 
                               max="1.0" 
                               step="0.05"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               :class="{ 'ring-2 ring-blue-500': searchScoreThreshold }">
                        <span class="text-xs font-medium text-blue-600 min-w-[3rem]" 
                              x-text="(searchScoreThreshold * 100).toFixed(0) + '%'"></span>
                    </div>
                    <div class="mt-1 text-xs text-gray-500">
                        <span x-show="searchScoreThreshold <= 0.3">Very loose (more results)</span>
                        <span x-show="searchScoreThreshold > 0.3 && searchScoreThreshold <= 0.6">Moderate (balanced)</span>
                        <span x-show="searchScoreThreshold > 0.6">Strict (exact matches)</span>
                    </div>
                    
                    <div x-show="isSearching" class="mt-2 text-sm text-blue-600">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Searching...
                    </div>
                    <div x-show="searchResults.length > 0 && !isSearching" class="mt-2 text-sm text-gray-600">
                        Found <span x-text="searchResults.length"></span> related documents
                    </div>
                    <div x-show="searchResults.length === 0 && searchQuery && !isSearching" class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                        <div class="flex items-center">
                            <i class="fas fa-search text-yellow-600 mr-2"></i>
                            <span class="text-sm text-yellow-800">No documents found matching "<span x-text="searchQuery"></span>"</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <!-- Search Results -->
                    <template x-if="searchResults.length > 0">
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-search mr-1"></i>Search Results
                            </div>
                            <template x-for="(result, i) in searchResults" :key="`search-${result.document_id}-${i}`">
                                <div @click="selectSearchResult(result)"
                                     class="p-3 border rounded-lg cursor-pointer transition-colors bg-blue-50 border-blue-200 hover:bg-blue-100">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-start flex-1 min-w-0">
                                            <i class="fas fa-file-alt text-blue-500 mr-3 mt-1"></i>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center mb-1">
                                                    <p class="text-sm font-medium text-gray-900 truncate" x-text="result.filename"></p>
                                                    <span class="ml-2 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                                        <span x-text="Math.round(result.score * 100)"></span>% match
                                                    </span>
                                                </div>
                                                <div class="text-xs text-gray-600 mb-2" x-text="result.excerpt"></div>
                                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                                    <span class="flex items-center">
                                                        <i class="fas fa-calendar mr-1"></i>
                                                        <span x-text="formatDate(result.upload_timestamp)"></span>
                                                    </span>
                                                    <span x-show="result.has_analysis" class="flex items-center text-green-600">
                                                        <i class="fas fa-check-circle mr-1"></i>
                                                        Analyzed
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Regular Document List -->
                    <template x-if="searchResults.length === 0">
                        <template x-for="(doc, i) in (documents || []).filter(d => d !== null && d !== undefined)" :key="doc?.id ?? `doc-${i}`">
                            <div @click="selectDocument(doc)"
                                 class="p-3 border rounded-lg cursor-pointer transition-colors"
                                 :class="currentDocument?.id === doc?.id ? 'bg-blue-50 border-blue-300' : 'border-gray-200 hover:bg-gray-50'"
                                 :style="(doc?.metadata?.file_storage?.error || doc?.metadata?.vector_processing?.error) ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start flex-1 min-w-0">
                                    <i class="fas fa-file-alt text-gray-400 mr-3 mt-1"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center mb-1">
                                            <p class="text-sm font-medium text-gray-900 truncate" x-text="doc?.original_filename || doc?.filename || 'Unknown'"></p>
                                            <i x-show="doc?.has_analysis" class="fas fa-check-circle text-green-500 ml-2" title="Analysis available"></i>
                                            <i x-show="doc?.metadata?.file_storage?.error || doc?.metadata?.vector_processing?.error" class="fas fa-exclamation-triangle text-red-500 ml-2" title="Document has errors"></i>
                                        </div>
                                        
                                        <!-- File metadata -->
                                        <div class="flex items-center space-x-3 text-xs text-gray-500 mb-1">
                                            <span class="flex items-center">
                                                <i class="fas fa-weight-hanging mr-1"></i>
                                                <span x-text="formatFileSize(doc?.file_size || 0)"></span>
                                            </span>
                                            <span x-show="doc?.file_type" class="flex items-center">
                                                <i class="fas fa-tag mr-1"></i>
                                                <span x-text="doc?.file_type?.toUpperCase()"></span>
                                            </span>
                                        </div>
                                        
                                        <!-- Timestamps -->
                                        <div class="flex items-center space-x-3 text-xs text-gray-500">
                                            <span class="flex items-center">
                                                <i class="fas fa-upload mr-1"></i>
                                                <span x-text="formatDate(doc?.upload_timestamp)"></span>
                                            </span>
                                            <span x-show="doc?.has_analysis && doc?.analysis_timestamp" class="flex items-center text-green-600">
                                                <i class="fas fa-chart-line mr-1"></i>
                                                <span x-text="formatDate(doc?.analysis_timestamp)"></span>
                                            </span>
                                        </div>
                                        
                                        <!-- Status Indicators -->
                                        <div class="flex items-center flex-wrap gap-1 mt-1">
                                            <!-- Analysis Status -->
                                            <span x-show="doc?.has_analysis" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check mr-1"></i>Analysis Complete
                                            </span>
                                            <span x-show="!doc?.has_analysis && !doc?.metadata?.file_storage?.error && !doc?.metadata?.vector_processing?.error" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                <i class="fas fa-clock mr-1"></i>Ready for Analysis
                                            </span>
                                            
                                            <!-- File Storage Error -->
                                            <span x-show="doc?.metadata?.file_storage?.error" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Storage Error
                                            </span>
                                            
                                            <!-- Vector Processing Error -->
                                            <span x-show="doc?.metadata?.vector_processing?.error" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Processing Error
                                            </span>
                                        </div>
                                        
                                        <!-- Error Details and Actions -->
                                        <div x-show="doc?.metadata?.file_storage?.error || doc?.metadata?.vector_processing?.error" class="mt-2 p-2 bg-gray-50 rounded text-xs">
                                            <!-- File Storage Error -->
                                            <div x-show="doc?.metadata?.file_storage?.error" class="mb-2">
                                                <div class="text-red-600 font-medium mb-1">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>File Storage Error:
                                                </div>
                                                <div class="text-red-500 mb-2" x-text="doc?.metadata?.file_storage?.error"></div>
                                                <button @click="reuploadDocument(doc?.id)" 
                                                        class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs hover:bg-red-200">
                                                    <i class="fas fa-upload mr-1"></i>Re-upload
                                                </button>
                                            </div>
                                            
                                            <!-- Vector Processing Error -->
                                            <div x-show="doc?.metadata?.vector_processing?.error">
                                                <div class="text-orange-600 font-medium mb-1">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>Vector Processing Error:
                                                </div>
                                                <div class="text-orange-500 mb-2" x-text="doc?.metadata?.vector_processing?.error"></div>
                                                <div class="flex space-x-2">
                                                    <button @click="reprocessDocument(doc?.id)" 
                                                            class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs hover:bg-orange-200">
                                                        <i class="fas fa-redo mr-1"></i>Retry Processing
                                                    </button>
                                                    <button @click="analyzeDocument(doc?.id)" 
                                                            class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs hover:bg-blue-200">
                                                        <i class="fas fa-chart-line mr-1"></i>Analyze Anyway
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button @click.stop="deleteDocument(doc?.id)"
                                        class="text-red-500 hover:text-red-700 ml-2 p-1">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                    </template>
                    
                    <div x-show="(documents || []).length === 0 && searchResults.length === 0" class="text-center text-gray-500 text-sm py-4">
                        No documents uploaded yet
                    </div>
                </div>
                
                <!-- Load More Button -->
                <div x-show="hasMoreDocuments" class="mt-4 text-center">
                    <button @click="loadMoreDocuments()" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                            :disabled="isLoadingDocuments">
                        <i class="fas fa-spinner fa-spin mr-2" x-show="isLoadingDocuments"></i>
                        <i class="fas fa-chevron-down mr-2" x-show="!isLoadingDocuments"></i>
                        <span x-text="isLoadingDocuments ? 'Loading...' : 'Load More Documents'"></span>
                    </button>
                </div>
            </div>

            <!-- Risk Filter -->
            <div class="p-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-filter mr-2"></i>Risk Filter
                </h3>
                <div class="space-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="riskFilters.low" class="mr-2">
                        <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800 border border-green-200">Low Risk</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="riskFilters.medium" class="mr-2">
                        <span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800 border border-yellow-200">Medium Risk</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="riskFilters.high" class="mr-2">
                        <span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800 border border-red-200">High Risk</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Center Panel: Analysis Results -->
        <div class="flex-1 flex flex-col">
            <!-- Analysis Header -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900" x-text="currentDocument?.filename || 'Select a document'"></h2>
                        
                        <!-- Document ID Viewer -->
                        <div x-show="currentDocument?.id" class="mt-2 mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-600">Document ID:</span>
                                <div class="flex items-center space-x-2 bg-gray-50 rounded-md px-3 py-1 border">
                                    <code class="text-sm font-mono text-gray-800" x-text="currentDocument?.id"></code>
                                    <button @click="copyDocumentId($event)" 
                                            class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded p-1"
                                            title="Copy Document ID">
                                        <i class="fas fa-copy text-xs"></i>
                                    </button>
                                    <button @click="openDataInspector()" 
                                            class="text-blue-500 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded p-1"
                                            title="Open in Data Inspector">
                                        <i class="fas fa-search text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600" x-show="currentSession">
                            Analysis completed â€¢ Confidence: <span x-text="Math.round((currentSession?.confidence_score || 0) * 100)"></span>%
                        </p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Export Button -->
                        <button @click="exportResults()" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50"
                                :disabled="!currentSession">
                            <i class="fas fa-download mr-2"></i>
                            Export Results
                        </button>
                        
                        <!-- Analyze/Re-analyze Button -->
                        <button @click="startAnalysis()" 
                                class="px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                :class="currentDocument?.has_analysis ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'"
                                :disabled="!currentDocument || isAnalyzing">
                            <i class="fas fa-play mr-2" x-show="!isAnalyzing && !currentDocument?.has_analysis"></i>
                            <i class="fas fa-redo mr-2" x-show="!isAnalyzing && currentDocument?.has_analysis"></i>
                            <i class="fas fa-spinner fa-spin mr-2" x-show="isAnalyzing"></i>
                            <span x-text="isAnalyzing ? 'Analyzing...' : (currentDocument?.has_analysis ? 'Re-analyze' : 'Analyze')"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Tabs -->
            <div class="bg-white border-b border-gray-200">
                <nav class="flex space-x-8 px-4">
                    <button @click="activeTab = 'summary'" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'summary' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-file-alt mr-2"></i>Summary
                    </button>
                    <button @click="activeTab = 'risks'" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'risks' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Risks
                    </button>
                    <button @click="activeTab = 'recommendations'" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'recommendations' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-lightbulb mr-2"></i>Recommendations
                    </button>
                    <button @click="activeTab = 'document'" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'document' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-file-alt mr-2"></i>Document View
                    </button>
                    <button @click="activeTab = 'comments'" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'comments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-comments mr-2"></i>Comments
                    </button>
                    <button @click="activeTab = 'logs'; loadDocumentLogs()" 
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            :class="activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        <i class="fas fa-history mr-2"></i>Log History
                    </button>
                </nav>
            </div>

            <!-- Analysis Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Summary Tab -->
                <div x-show="activeTab === 'summary'" x-transition class="space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Executive Summary
                        </h3>
                        <div class="prose max-w-none text-gray-700 leading-relaxed" x-html="formatSummary(currentSession?.summary?.summary)"></div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-list mr-2"></i>Key Points
                        </h3>
                        <div class="prose max-w-none text-gray-700 leading-relaxed" x-html="formatKeyPoints(currentSession?.summary?.key_points)"></div>
                    </div>
                </div>

                <!-- Risks Tab -->
                <div x-show="activeTab === 'risks'" x-transition class="space-y-4">
                    <div x-show="!currentSession" class="text-center text-gray-500 py-8">
                        Please analyze a document first to see risks.
                    </div>
                    <template x-for="(risk, i) in filteredRisks" :key="risk.id ?? `risk-${i}`">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-medium mr-3"
                                              :class="getRiskClass(risk.level)"
                                              x-text="risk.level || 'Unknown'"></span>
                                        <h4 class="text-lg font-semibold text-gray-900" x-text="risk.title || risk.description || 'Untitled Risk'"></h4>
                                    </div>
                                    <p class="text-gray-700 mb-3" x-text="risk.description || 'No description available'"></p>
                                    
                                    <!-- Impact information -->
                                    <div class="text-sm text-gray-600 mb-2" x-show="risk.impact">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        <span x-text="risk.impact"></span>
                                    </div>
                                    
                                    <!-- Section/Location -->
                                    <div class="text-sm text-gray-500 mb-2" x-show="risk.section || risk.location">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span x-text="risk.section || risk.location"></span>
                                    </div>
                                    
                                    <!-- Citation -->
                                    <div class="text-sm text-blue-600 mb-2" x-show="risk.citation">
                                        <i class="fas fa-quote-left mr-1"></i>
                                        <span x-text="risk.citation"></span>
                                    </div>
                                    
                                    <!-- Text Excerpt -->
                                    <div class="text-xs text-gray-500 italic bg-gray-50 p-2 rounded" x-show="risk.text_excerpt">
                                        <i class="fas fa-file-text mr-1"></i>
                                        <span x-text="risk.text_excerpt"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Recommendations Tab -->
                <div x-show="activeTab === 'recommendations'" x-transition class="space-y-4">
                    <div x-show="!currentSession" class="text-center text-gray-500 py-8">
                        Please analyze a document first to see recommendations.
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="prose max-w-none text-gray-700 leading-relaxed" x-html="formatRecommendations(currentSession?.recommendations)"></div>
                    </div>
                </div>

                <!-- Document View Tab -->
                <div x-show="activeTab === 'document'" x-transition class="space-y-4">
                    <div x-show="!currentSession" class="text-center text-gray-500 py-8">
                        Please analyze a document first to view the document with analysis highlights.
                    </div>
                    
                    <!-- Document Viewer Controls -->
                    <div x-show="currentSession" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-file-alt mr-2"></i>Document Analysis View
                            </h3>
                            <div class="flex items-center space-x-4">
                                <!-- View Mode Toggle -->
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600">View:</span>
                                    <button @click="documentViewMode = 'side-by-side'" 
                                            class="px-3 py-1 text-sm rounded-md transition-colors"
                                            :class="documentViewMode === 'side-by-side' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                        <i class="fas fa-columns mr-1"></i>Side by Side
                                    </button>
                                    <button @click="documentViewMode = 'overlay'" 
                                            class="px-3 py-1 text-sm rounded-md transition-colors"
                                            :class="documentViewMode === 'overlay' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                        <i class="fas fa-layer-group mr-1"></i>Overlay
                                    </button>
                                    <button @click="documentViewMode = 'document-only'" 
                                            class="px-3 py-1 text-sm rounded-md transition-colors"
                                            :class="documentViewMode === 'document-only' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                        <i class="fas fa-file mr-1"></i>Document Only
                                    </button>
                                    <button @click="documentViewMode = 'original'" 
                                            class="px-3 py-1 text-sm rounded-md transition-colors"
                                            :class="documentViewMode === 'original' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                        <i class="fas fa-file-pdf mr-1"></i>Original File
                                    </button>
                                </div>
                                
                                <!-- Highlight Toggle -->
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600">Highlights:</span>
                                    <button @click="showHighlights = !showHighlights" 
                                            class="px-3 py-1 text-sm rounded-md transition-colors"
                                            :class="showHighlights ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                        <i class="fas fa-highlighter mr-1"></i>
                                        <span x-text="showHighlights ? 'On' : 'Off'"></span>
                                    </button>
                                </div>
                                
                                
                                <!-- Download Document -->
                                <button @click="downloadDocument()" 
                                        class="px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                                    <i class="fas fa-download mr-1"></i>Download
                                </button>
                            </div>
                        </div>
                        
                        <!-- Analysis Summary -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-md">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-600">Key Points:</span>
                                    <span class="ml-2 text-gray-900" x-text="currentSession?.summary?.key_points?.length || 0"></span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Risks:</span>
                                    <span class="ml-2 text-gray-900" x-text="currentSession?.risks?.length || 0"></span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">Recommendations:</span>
                                    <span class="ml-2 text-gray-900" x-text="currentSession?.recommendations?.length || 0"></span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Document Content -->
                    <div x-show="currentSession" class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <!-- Side by Side View -->
                        <div x-show="documentViewMode === 'side-by-side'" class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6 h-full">
                            <!-- Analysis Panel -->
                            <div class="space-y-4 overflow-y-auto">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-chart-line mr-2"></i>Analysis Summary
                                </h4>
                                
                                <!-- Key Points -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-blue-900 mb-2">Key Points</h5>
                                    <div class="space-y-2">
                                        <template x-for="(point, i) in currentSession?.summary?.key_points || []" :key="i">
                                            <div class="text-sm">
                                                <button @click="highlightInDocument(point)" 
                                                        class="text-blue-700 hover:text-blue-900 underline cursor-pointer"
                                                        x-text="typeof point === 'string' ? point : point.point"></button>
                                                <div x-show="typeof point === 'object' && point.citation" 
                                                     class="text-xs text-gray-500 mt-1" 
                                                     x-text="point.citation"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Risks -->
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-red-900 mb-2">Risks</h5>
                                    <div class="space-y-2">
                                        <template x-for="(risk, i) in currentSession?.risks || []" :key="i">
                                            <div class="text-sm">
                                                <button @click="highlightInDocument(risk)" 
                                                        class="text-red-700 hover:text-red-900 underline cursor-pointer"
                                                        x-text="risk.description || risk.title"></button>
                                                <div x-show="risk.citation" 
                                                     class="text-xs text-gray-500 mt-1" 
                                                     x-text="risk.citation"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Recommendations -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-green-900 mb-2">Recommendations</h5>
                                    <div class="space-y-2">
                                        <template x-for="(rec, i) in currentSession?.recommendations || []" :key="i">
                                            <div class="text-sm">
                                                <button @click="highlightInDocument(rec)" 
                                                        class="text-green-700 hover:text-green-900 underline cursor-pointer"
                                                        x-text="typeof rec === 'string' ? rec : rec.recommendation"></button>
                                                <div x-show="typeof rec === 'object' && rec.citation" 
                                                     class="text-xs text-gray-500 mt-1" 
                                                     x-text="rec.citation"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Document Panel -->
                            <div class="border border-gray-200 rounded-lg flex flex-col h-full">
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 rounded-t-lg flex-shrink-0">
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-file-alt mr-2"></i>Document Content
                                    </h4>
                                </div>
                                <div class="p-4 flex-1 overflow-y-auto">
                                    
                                    <!-- Formatted Content Display -->
                                    <div :key="documentRenderKey"
                                         id="document-content"
                                         class="text-sm leading-relaxed whitespace-pre-wrap break-words"
                                         x-html="documentContent || '<p class=&quot;text-gray-500&quot;>No content loaded</p>'"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Overlay View -->
                        <div x-show="documentViewMode === 'overlay'" class="relative p-6">
                            <div class="prose max-w-none text-sm leading-relaxed" 
                                 x-html="documentContent"></div>
                            
                            <!-- Floating Analysis Panel -->
                            <div class="fixed top-4 right-4 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 rounded-t-lg">
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-chart-line mr-2"></i>Analysis
                                    </h4>
                                </div>
                                <div class="p-4 max-h-96 overflow-y-auto">
                                    <!-- Analysis content here -->
                                    <div class="text-sm text-gray-600">
                                        Click on analysis items to highlight in document
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Document Only View -->
                        <div x-show="documentViewMode === 'document-only'" class="p-6">
                            <div class="prose max-w-none text-sm leading-relaxed" 
                                 x-html="documentContent"></div>
                        </div>
                        
                        <!-- Original File View -->
                        <div x-show="documentViewMode === 'original'" class="p-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 rounded-t-lg">
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-file-pdf mr-2"></i>Original Document
                                    </h4>
                                </div>
                                <div class="p-4">
                                    <!-- File Type Detection -->
                                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-medium text-blue-900">
                                                    <span x-text="currentDocument?.original_filename || 'Unknown file'"></span>
                                                </div>
                                                <div class="text-sm text-blue-700">
                                                    File Type: <span x-text="currentDocument?.file_type || 'Unknown'"></span>
                                                </div>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button @click="downloadDocument()" 
                                                        class="px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                                                    <i class="fas fa-download mr-1"></i>Download
                                                </button>
                                                <button @click="openOriginalInNewTab()" 
                                                        class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700"
                                                        :title="isPdfFile() ? 'Open PDF in browser viewer' : 'Download Word document for viewing'">
                                                    <i class="fas fa-external-link-alt mr-1"></i>
                                                    <span x-text="isPdfFile() ? 'View PDF' : 'Download & View'"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- PDF Viewer -->
                                    <div x-show="isPdfFile()" class="border border-gray-200 rounded-lg">
                                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                            <h5 class="font-medium text-gray-900">PDF Preview</h5>
                                        </div>
                                        <div class="p-4">
                                            <div id="pdf-viewer" class="w-full h-96 border border-gray-200 rounded">
                                                <div class="flex items-center justify-center h-full text-gray-500">
                                                    <div class="text-center">
                                                        <i class="fas fa-file-pdf text-4xl mb-2"></i>
                                                        <p>PDF viewer will be loaded here</p>
                                                        <p class="text-sm">Click "Open" to view in new tab</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Word Document Display -->
                                    <div x-show="!isPdfFile()" class="border border-gray-200 rounded-lg">
                                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                            <h5 class="font-medium text-gray-900">Document Content</h5>
                                        </div>
                                        <div class="p-4">
                                            <!-- Helpful message for Word documents -->
                                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                <div class="flex items-start">
                                                    <i class="fas fa-info-circle text-yellow-600 mt-1 mr-2"></i>
                                                    <div class="text-sm text-yellow-800">
                                                        <p class="font-medium mb-1">Word Document Viewing Options:</p>
                                                        <ul class="list-disc list-inside space-y-1">
                                                            <li><strong>Download & View:</strong> Downloads the Word document and offers viewing options (Word, Google Drive, Office Online)</li>
                                                            <li><strong>Download:</strong> Downloads the original .docx file to your computer</li>
                                                            <li><strong>Document Content:</strong> Shows the extracted text content below (formatted for analysis)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="prose max-w-none text-sm leading-relaxed" 
                                                 x-html="documentContent"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- File Information -->
                                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                        <h6 class="font-medium text-gray-900 mb-2">File Information</h6>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-600">File Size:</span>
                                                <span class="font-mono" x-text="formatFileSize(currentDocument?.file_size)"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Upload Date:</span>
                                                <span x-text="formatDate(currentDocument?.upload_timestamp)"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Analysis Date:</span>
                                                <span x-text="formatDate(currentDocument?.analysis_timestamp)"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-600">Status:</span>
                                                <span class="font-medium" x-text="currentDocument?.status || 'Unknown'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments Tab -->
                <div x-show="activeTab === 'comments'" x-transition class="space-y-4">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Comment</h3>
                        <textarea x-model="newComment" 
                                  class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  rows="3" 
                                  placeholder="Add your comment here..."></textarea>
                        <button @click="addComment()" 
                                class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add Comment
                        </button>
                    </div>
                    
                    <template x-for="comment in comments" :key="comment.id">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-700" x-text="comment.text"></p>
                                    <p class="text-sm text-gray-500 mt-2" x-text="formatDate(comment.created_at)"></p>
                                </div>
                                <button @click="deleteComment(comment.id)"
                                        class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Log History Tab -->
                <div x-show="activeTab === 'logs'" x-transition class="space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-history mr-2"></i>Document Log History
                            </h3>
                            <div class="flex items-center space-x-4">
                                <!-- Log Level Filter -->
                                <select x-model="logLevelFilter" @change="loadDocumentLogs()" 
                                        class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">All Levels</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="DEBUG">DEBUG</option>
                                </select>
                                
                                <!-- Search Input -->
                                <input x-model="logSearchTerm" @input="debounceLoadLogs()" 
                                       type="text" placeholder="Search logs..." 
                                       class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">
                                
                                <!-- Refresh Button -->
                                <button @click="loadDocumentLogs()" 
                                        class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Log Stats -->
                        <div x-show="documentLogs" class="mb-4 p-3 bg-gray-50 rounded-md">
                            <div class="flex items-center justify-between text-sm text-gray-600">
                                <span x-text="`Showing ${documentLogs?.logs?.length || 0} of ${documentLogs?.pagination?.total_count || 0} log entries`"></span>
                                <span x-show="documentLogs?.note" class="text-orange-600 font-medium" x-text="documentLogs.note"></span>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div x-show="loadingLogs" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Loading log history...</p>
                        </div>

                        <!-- Log Entries -->
                        <div x-show="!loadingLogs && documentLogs?.logs?.length > 0" class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="log in documentLogs.logs" :key="log.timestamp + log.message">
                                <div class="border border-gray-200 rounded-md p-3 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span :class="{
                                                    'text-green-600': log.level === 'INFO',
                                                    'text-yellow-600': log.level === 'WARNING', 
                                                    'text-red-600': log.level === 'ERROR',
                                                    'text-blue-600': log.level === 'DEBUG'
                                                }" class="text-xs font-medium px-2 py-1 rounded" x-text="log.level"></span>
                                                <span class="text-xs text-gray-500 font-mono" x-text="log.timestamp"></span>
                                            </div>
                                            <p class="text-sm text-gray-700 font-mono" x-text="log.message"></p>
                                        </div>
                                        <button @click="copyLogMessage(log.raw)" 
                                                class="text-gray-400 hover:text-gray-600 ml-2" 
                                                title="Copy log entry">
                                            <i class="fas fa-copy text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Empty State -->
                        <div x-show="!loadingLogs && (!documentLogs?.logs || documentLogs.logs.length === 0)" 
                             class="text-center py-8 text-gray-500">
                            <i class="fas fa-file-alt text-3xl mb-2"></i>
                            <p>No log entries found for this document</p>
                            <p class="text-sm">Try adjusting your filters or check back later</p>
                        </div>

                        <!-- Pagination -->
                        <div x-show="documentLogs?.pagination?.has_more" class="mt-4 flex justify-center">
                            <button @click="loadMoreLogs()" 
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                                <i class="fas fa-chevron-down mr-2"></i>Load More
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Chat & Insights -->
        <div class="w-80 bg-white border-l border-gray-200 flex flex-col">
            <!-- Chat Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-comments mr-2"></i>Ask the Contract
                    </h3>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-600">Search Mode:</label>
                        <div class="flex items-center space-x-2">
                            <button @click="globalChatMode = false" 
                                    :class="!globalChatMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-md text-sm font-medium transition-colors">
                                Current Doc
                            </button>
                            <button @click="globalChatMode = true" 
                                    :class="globalChatMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-md text-sm font-medium transition-colors">
                                All Docs
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    <span x-show="!globalChatMode">Ask questions about the currently selected document</span>
                    <span x-show="globalChatMode">Ask questions across all documents in the system</span>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" x-ref="chatContainer">
                <div x-show="chatMessages.length === 0" class="text-center text-gray-500 text-sm py-4">
                    <span x-show="!globalChatMode">Select a document to start asking questions about it.</span>
                    <span x-show="globalChatMode">Ask questions across all documents in the system.</span>
                </div>
                <template x-for="message in chatMessages" :key="message.id">
                    <div class="flex" :class="message.role === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs px-4 py-2 rounded-lg break-words"
                             :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'">
                            <p x-text="message.content"></p>
                            <p class="text-xs mt-1 opacity-70" x-text="formatTime(message.timestamp)"></p>
                            <!-- Global chat metadata -->
                            <div x-show="message.role === 'assistant' && message.documents_used" class="mt-2 pt-2 border-t border-gray-300">
                                <p class="text-xs text-gray-600">
                                    <i class="fas fa-search mr-1"></i>
                                    Searched <span x-text="message.total_documents_searched"></span> documents
                                </p>
                                <div class="mt-1 space-y-1">
                                    <template x-for="doc in message.documents_used" :key="doc.id">
                                        <div class="text-xs text-gray-500 flex items-center">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            <span x-text="doc.filename"></span>
                                            <span x-show="doc.status === 'analyzed'" class="ml-1 text-green-600" title="Analyzed">
                                                <i class="fas fa-check-circle"></i>
                                            </span>
                                            <span x-show="doc.status === 'uploaded'" class="ml-1 text-yellow-600" title="Raw content only">
                                                <i class="fas fa-upload"></i>
                                            </span>
                                            <span x-show="doc.has_analysis" class="ml-1 text-blue-600" title="Has AI analysis">
                                                <i class="fas fa-brain"></i>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex space-x-2">
                    <input x-model="chatMessage" 
                           @keydown.enter="sendChatMessage()"
                           class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ask about the contract..."
                           :disabled="!currentSession">
                    <button @click="sendChatMessage()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                            :disabled="!chatMessage || !currentSession || isChatting">
                        <i class="fas fa-paper-plane" x-show="!isChatting"></i>
                        <i class="fas fa-spinner fa-spin" x-show="isChatting"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div x-show="showHelp" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click.self="showHelp = false"
         @keydown.escape.window="showHelp = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         role="dialog"
         aria-modal="true"
         aria-labelledby="help-title"
         x-cloak>
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="help-title" class="text-lg font-semibold text-gray-900">Help & Guide</h3>
                <button @click="showHelp = false" 
                        class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded p-1"
                        aria-label="Close help">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="prose max-w-none">
                <h4>Getting Started</h4>
                <ol>
                    <li>Upload a PDF or DOCX contract document</li>
                    <li>Click "Analyze" to perform AI-powered contract review</li>
                    <li>Review results in the Summary, Risks, and Recommendations tabs</li>
                    <li>Use the chat feature to ask specific questions about the contract</li>
                    <li>Export results when ready</li>
                </ol>
                
                <h4>Features</h4>
                <ul>
                    <li><strong>Three-Panel Layout:</strong> Document navigation, analysis results, and chat interface</li>
                    <li><strong>AI Analysis:</strong> Comprehensive contract review with risk assessment</li>
                    <li><strong>Risk Filtering:</strong> Filter results by risk level (Low, Medium, High)</li>
                    <li><strong>Chat Interface:</strong> Ask questions about specific contract clauses</li>
                    <li><strong>Export Options:</strong> Export analysis results in multiple formats</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettings" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click.self="showSettings = false"
         @keydown.escape.window="showSettings = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         role="dialog"
         aria-modal="true"
         aria-labelledby="settings-title"
         x-cloak>
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="settings-title" class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-cog mr-2"></i>Application Settings
                </h3>
                <button @click="showSettings = false" 
                        class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded p-1"
                        aria-label="Close settings">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Model Configuration -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-robot mr-2"></i>Model Configuration
                    </h4>
                    
                    <div class="space-y-4">
                        <!-- LLM Model Selection -->
                        <div x-show="absFramework">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                LLM Model (Chat & Analysis)
                            </label>
                            <select x-model="absFramework.selectedModel" 
                                    @change="absFramework?.handleModelChange('llm', $event.target.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select the language model for contract analysis</option>
                                <template x-for="model in (absFramework?.availableModels || [])" :key="model.id">
                                    <option :value="model.id" x-text="model.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Embedding Model Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Embedding Model (Vector Search)
                            </label>
                            <select x-model="selectedEmbeddingModel" 
                                    @change="updateModel('embedding', $event.target.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select the embedding model for semantic search</option>
                                <option value="legal-bert">legal-bert</option>
                                <option value="all-MiniLM-L6-v2">all-MiniLM-L6-v2</option>
                            </select>
                        </div>
                        
                        <!-- Current Models Display -->
                        <div class="bg-white rounded-lg p-4">
                            <h5 class="text-sm font-medium text-gray-700 mb-2">Current Models:</h5>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div><strong>LLM:</strong> <span x-text="absFramework?.selectedModel || 'Not selected'"></span></div>
                                <div><strong>Embedding:</strong> <span x-text="absFramework?.selectedEmbeddingModel || 'Not selected'"></span></div>
                            </div>
                        </div>
                        
                        <!-- Refresh Button -->
                        <button @click="loadModels()" 
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Model List
                        </button>
                    </div>
                </div>
                
                <!-- Processing Options -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-cogs mr-2"></i>Processing Options
                    </h4>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Document chunk size:</span>
                            <span class="text-sm font-medium text-gray-900">1200 characters</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Overlap:</span>
                            <span class="text-sm font-medium text-gray-900">120 characters</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Vector dimension:</span>
                            <span class="text-sm font-medium text-gray-900">768</span>
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-server mr-2"></i>System Status
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-600">Hub Gateway: Connected</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-600">Vector Database: Active</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-600">Cache: Enabled</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-600">Reports: Stored locally</span>
                        </div>
                    </div>
                </div>
                
                <!-- Vector Database Status -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-database mr-2"></i>Vector Database Status
                    </h4>
                    
                    <div class="space-y-4">
                        <!-- Connection Status -->
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-900">Vector Database Status: Connected</span>
                        </div>
                        
                        <!-- Database Details Grid -->
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-robot text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Embedding Model</div>
                                    <div class="font-medium text-gray-900" x-text="selectedEmbeddingModel || 'legal-bert'"></div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-ruler text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Dimension</div>
                                    <div class="font-medium text-gray-900">768</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-triangle text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Distance Metric</div>
                                    <div class="font-medium text-gray-900">cosine</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-folder text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Collection Name</div>
                                    <div class="font-medium text-gray-900" x-text="(selectedEmbeddingModel || 'legal-bert') + '_vectors'"></div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-chart-bar text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Vector Count</div>
                                    <div class="font-medium text-gray-900" x-text="vectorCount || 'Loading...'"></div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Last Update</div>
                                    <div class="font-medium text-gray-900">Optimized</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Owner App</div>
                                    <div class="font-medium text-gray-900">Contract Reviewer</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-bullseye text-gray-400 mr-2"></i>
                                <div>
                                    <div class="text-gray-500">Scope</div>
                                    <div class="font-medium text-gray-900">App-specific</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refresh Button -->
                        <button @click="refreshVectorStatus()" 
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Vector Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review History Tab -->
    <div x-show="mainTab === 'history'" class="flex h-screen pt-16">
        <div class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    <i class="fas fa-history mr-2"></i>Review History
                </h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-500 text-center py-8">Review history feature coming soon...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('contractReviewer', () => ({
                // State
                mainTab: 'documents',  // Main navigation tab
                documents: [],
                totalDocuments: 0,
                documentsLimit: 10,
                documentsOffset: 0,
                hasMoreDocuments: false,
                isLoadingDocuments: false,
                
                // Search functionality
                searchQuery: '',
                searchResults: [],
                isSearching: false,
                searchDebounceTimer: null,
                searchScoreThreshold: 0.5,  // Configurable search similarity threshold (0.0 to 1.0)
                
                // Stub absFramework to prevent first-render errors
                // The unified framework will replace/extend this when it loads
                absFramework: {
                    showAppLauncher: false,
                    appSearchQuery: '',
                    currentApp: { 
                        name: 'Loadingâ€¦', 
                        description: '', 
                        icon: 'fas fa-cube', 
                        colorClass: 'bg-gray-300' 
                    },
                    availableApps: [],
                    customMenuItems: [],
                    notifications: [],
                    user: { name: 'User', avatar: null },
                    config: { 
                        gatewayUrl: '/', 
                        appRegistryUrl: '/api/apps', 
                        enableNotifications: false, 
                        enableSettings: false, 
                        enableExport: false 
                    },
                    selectedModel: '',
                    availableModels: [],
                    selectedEmbeddingModel: '',
                    
                    // Stub methods to prevent errors
                    handleModelChange: () => {},
                    switchToApp: () => {},
                    goToGateway: () => {},
                    openSettings: () => {},
                    loadModels: () => {}
                },
                
                
                // Settings
                selectedEmbeddingModel: 'all-MiniLM-L6-v2',
                vectorCount: 0,
                currentDocument: null,
                currentSession: null,
                availableModels: [],
                activeTab: 'summary',
                isAnalyzing: false,
                isChatting: false,
                uploadProgress: 0,
                uploadStatus: '',
                isDragOver: false,
                chatMessages: [],
                chatMessage: '',
                globalChatMode: false,  // Toggle between current doc and all docs
                comments: [],
                newComment: '',
                showHelp: false,
                
                // Document Viewer
                documentViewMode: 'side-by-side',
                showHighlights: true,
                documentContent: '',
                highlightedText: null,
                documentRenderKey: 0,
                showSettings: false,
                riskFilters: {
                    low: true,
                    medium: true,
                    high: true
                },

                // Log History
                documentLogs: null,
                loadingLogs: false,
                logLevelFilter: '',
                logSearchTerm: '',
                logOffset: 0,
                logLimit: 50,
                logDebounceTimer: null,

                // Computed
                get filteredRisks() {
                    // Always return an array, never false or undefined
                    if (!this.currentSession?.risks || !Array.isArray(this.currentSession.risks)) {
                        return [];
                    }
                    
                    return this.currentSession.risks.filter(risk => {
                        if (!risk || typeof risk !== 'object') return false;
                        const level = risk.level?.toLowerCase();
                        return (level === 'low' && this.riskFilters.low) ||
                               (level === 'medium' && this.riskFilters.medium) ||
                               (level === 'high' && this.riskFilters.high);
                    });
                },

                get documentsWithErrors() {
                    return (this.documents || []).filter(doc => 
                        doc?.metadata?.file_storage?.error || 
                        doc?.metadata?.vector_processing?.error
                    );
                },

                // Methods
                async init() {
                    await this.loadModels();
                    await this.loadDocuments(true);
                    
                    // Watch for activeTab changes
                    this.$watch('activeTab', (newTab) => {
                        if (newTab === 'document' && this.currentDocument) {
                            this.loadDocumentContent();
                        }
                    });
                },


                async loadModels() {
                    try {
                        // Use framework's model loading
                        if (this.absFramework && this.absFramework.loadModels) {
                            await this.absFramework.loadModels();
                        } else {
                            console.warn('âš ï¸ Framework not available for model loading');
                        }
                    } catch (error) {
                        console.error('Error loading models:', error);
                    }
                },

                async loadDocuments(reset = false) {
                    try {
                        
                        if (reset) {
                            this.documentsOffset = 0;
                            this.documents = [];
                        }
                        
                        this.isLoadingDocuments = true;
                        const response = await fetch(`/api/documents?limit=${this.documentsLimit}&offset=${this.documentsOffset}`);
                        const data = await response.json();
                        
                        // Include all documents, including those with errors
                        const rawDocuments = data.documents || [];
                        
                        // Only filter out completely null/undefined documents
                        const validDocuments = rawDocuments.filter(doc => doc !== null && doc !== undefined);
                        
                        if (reset) {
                            this.documents = validDocuments;
                        } else {
                            this.documents = [...this.documents, ...validDocuments];
                        }
                        
                        // Set totalDocuments to the total count from API
                        this.totalDocuments = data.total_count || 0;
                        this.hasMoreDocuments = data.has_more || false;
                        this.documentsOffset = this.documents.length;
                        
                    } catch (error) {
                        console.error('Error loading documents:', error);
                    } finally {
                        this.isLoadingDocuments = false;
                    }
                },

                async loadMoreDocuments() {
                    await this.loadDocuments(false);
                },

                async handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    for (const file of files) {
                        await this.uploadFile(file);
                    }
                },

                async handleFileDrop(event) {
                    this.isDragOver = false;
                    const files = Array.from(event.dataTransfer.files);
                    for (const file of files) {
                        await this.uploadFile(file);
                    }
                },

                async uploadFile(file) {
                    this.uploadProgress = 50;
                    this.uploadStatus = 'Uploading...';

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (response.ok) {
                            this.uploadStatus = 'Upload successful!';
                            this.uploadProgress = 100;
                            await this.loadDocuments(true); // Reset to show newest documents
                            
                            // Auto-select the uploaded document
                            if (result.document_id) {
                                // Find the uploaded document in the list
                                const uploadedDoc = this.documents.find(doc => doc.id === result.document_id);
                                if (uploadedDoc) {
                                    await this.selectDocument(uploadedDoc);
                                }
                            }
                            
                            setTimeout(() => {
                                this.uploadProgress = 0;
                                this.uploadStatus = '';
                            }, 2000);
                        } else {
                            this.uploadStatus = `Error: ${result.detail}`;
                            this.uploadProgress = 0;
                        }
                    } catch (error) {
                        this.uploadStatus = `Error: ${error.message}`;
                        this.uploadProgress = 0;
                    }
                },

                // Search functionality
                debounceSearch() {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(() => {
                        if (this.searchQuery.trim()) {
                            this.performSearch();
                        } else {
                            this.clearSearch();
                        }
                    }, 500);
                },

                async performSearch() {
                    if (!this.searchQuery.trim()) {
                        this.clearSearch();
                        return;
                    }

                    this.isSearching = true;
                    try {
                        const response = await fetch('/api/search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                query: this.searchQuery,
                                limit: 10,
                                score_threshold: this.searchScoreThreshold || 0.5
                            })
                        });

                        if (response.ok) {
                            const results = await response.json();
                            this.searchResults = results.results || [];
                        } else {
                            console.error('Search failed:', response.statusText);
                            this.searchResults = [];
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                        this.searchResults = [];
                    } finally {
                        this.isSearching = false;
                    }
                },

                clearSearch() {
                    this.searchQuery = '';
                    this.searchResults = [];
                    this.isSearching = false;
                    clearTimeout(this.searchDebounceTimer);
                },

                async selectSearchResult(result) {
                    // Find the full document from the search result
                    const fullDoc = this.documents.find(doc => doc.id === result.document_id);
                    if (fullDoc) {
                        await this.selectDocument(fullDoc);
                    } else {
                        // If document not in current list, fetch it
                        try {
                            const response = await fetch(`/api/documents/${result.document_id}`);
                            if (response.ok) {
                                const doc = await response.json();
                                await this.selectDocument(doc);
                            }
                        } catch (error) {
                            console.error('Error fetching document:', error);
                        }
                    }
                },

                async selectDocument(doc) {
                    // Check if document has errors before selecting
                    if (doc.metadata?.file_storage?.error || doc.metadata?.vector_processing?.error) {
                        console.warn('âš ï¸ Document has errors, skipping selection:', doc.original_filename);
                        return;
                    }
                    
                    this.currentDocument = doc;
                    
                    // Create a session for this document
                    try {
                        const response = await fetch(`/api/sessions?document_id=${doc.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const sessionData = await response.json();
                            this.currentSession = sessionData;
                            console.log('âœ… Session created:', sessionData);
                        } else {
                            console.error('Failed to create session:', response.statusText);
                            // Fallback to local session
                            this.currentSession = {
                                session_id: `session_${doc.id}_${Date.now()}`,
                                document_id: doc.id,
                                created_at: new Date().toISOString()
                            };
                        }
                    } catch (error) {
                        console.error('Error creating session:', error);
                        // Fallback to local session
                        this.currentSession = {
                            session_id: `session_${doc.id}_${Date.now()}`,
                            document_id: doc.id,
                            created_at: new Date().toISOString()
                        };
                    }
                    
                    this.chatMessages = [];
                    
                    // Load saved analysis if available
                    if (doc.has_analysis) {
                        await this.loadSavedAnalysis(doc.id);
                    }
                },

                async loadSavedAnalysis(documentId) {
                    try {
                        const response = await fetch(`/api/analysis/${documentId}`);
                        
                        if (response.ok) {
                            const result = await response.json();
                            // Preserve the current session and add analysis data
                            this.currentSession = {
                                ...this.currentSession,
                                ...result
                            };
                            this.activeTab = 'summary';
                        } else if (response.status === 404) {
                        } else {
                            console.error('Error loading saved analysis:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error loading saved analysis:', error);
                    }
                },

                async startAnalysis() {
                    if (!this.currentDocument || !this.currentDocument.id) {
                        alert('Please select a document first');
                        return;
                    }

                    // If document already has analysis, confirm re-analysis
                    if (this.currentDocument?.has_analysis) {
                        const confirmed = confirm(
                            'This document already has an analysis. Do you want to re-analyze it?\n\n' +
                            'This will:\n' +
                            'â€¢ Generate a new AI analysis\n' +
                            'â€¢ Update the existing analysis results\n' +
                            'â€¢ May take 30-60 seconds\n\n' +
                            'Click OK to proceed with re-analysis.'
                        );
                        
                        if (!confirmed) {
                            return;
                        }
                    }

                    this.isAnalyzing = true;
                    const isReanalysis = this.currentDocument?.has_analysis || false;
                    
                    try {
                        const response = await fetch(`/api/analyze/${this.currentDocument.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                analysis_type: 'comprehensive',
                                include_recommendations: true,
                                include_risks: true,
                                include_citations: true,
                                force_reanalysis: this.currentDocument?.has_analysis || false  // Force re-analysis if document already has analysis
                            })
                        });

                        const result = await response.json();
                        
                        if (response.ok) {
                            this.currentSession = result;
                            this.activeTab = 'summary';
                            
                            // Force refresh document list to show updated analysis status
                            await this.loadDocuments(true);
                            
                            // Update current document to reflect analysis status
                            if (this.currentDocument) {
                                this.currentDocument.has_analysis = true;
                                this.currentDocument.analysis_timestamp = new Date().toISOString();
                            }
                        } else {
                            alert(`Error: ${result.detail}`);
                        }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    } finally {
                        this.isAnalyzing = false;
                    }
                },

                async sendChatMessage() {
                    if (!this.chatMessage) return;
                    
                    // Check if we have a session for current doc mode
                    if (!this.globalChatMode && !this.currentSession) {
                        alert('Please select a document first for current document chat mode.');
                        return;
                    }

                    const userMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: this.chatMessage,
                        timestamp: new Date()
                    };

                    this.chatMessages.push(userMessage);
                    const message = this.chatMessage;
                    this.chatMessage = '';
                    this.isChatting = true;

                    try {
                        let response;
                        
                        if (this.globalChatMode) {
                            // Global chat - search across all documents
                            const requestBody = {
                                message: message,
                                model: this.absFramework?.selectedModel || null,
                                search_limit: 5,
                                include_analysis: true
                            };
                            
                            console.log('ðŸ” Global chat request body:', requestBody);
                            
                            response = await fetch('/api/chat/global', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestBody)
                            });
                        } else {
                            // Current document chat
                            const requestBody = {
                                session_id: this.currentSession.session_id,
                                message: message,
                                model: this.absFramework?.selectedModel || null
                            };
                            
                            console.log('ðŸ” Chat request body:', requestBody);
                            console.log('ðŸ” Current session:', this.currentSession);
                            
                            response = await fetch('/api/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestBody)
                            });
                        }

                        const result = await response.json();
                        
                        if (response.ok) {
                            const aiMessage = {
                                id: Date.now() + 1,
                                role: 'assistant',
                                content: result.response,
                                timestamp: new Date(),
                                // Add metadata for global chat
                                ...(this.globalChatMode && {
                                    documents_used: result.documents_used,
                                    total_documents_searched: result.total_documents_searched
                                })
                            };
                            this.chatMessages.push(aiMessage);
                            this.$nextTick(() => {
                                this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight;
                            });
                        } else {
                            console.error('âŒ Chat API error:', response.status, result);
                            alert(`Error: ${result.detail || 'Unknown error occurred'}`);
                        }
                    } catch (error) {
                        console.error('âŒ Chat request failed:', error);
                        alert(`Error: ${error.message}`);
                    } finally {
                        this.isChatting = false;
                    }
                },

                async deleteDocument(documentId) {
                    if (!confirm('Are you sure you want to delete this document?')) return;

                    try {
                        const response = await fetch(`/api/documents/${documentId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            // Clear current document if it was deleted
                            if (this.currentDocument?.id === documentId) {
                                this.currentDocument = null;
                                this.currentSession = null;
                                this.chatMessages = [];
                            }
                            
                            // Refresh the document list with a small delay to ensure cache is cleared
                            setTimeout(async () => {
                                await this.loadDocuments(true);
                            }, 100);
                        } else {
                            const errorData = await response.json();
                            alert(`Error deleting document: ${errorData.detail || 'Unknown error'}`);
                        }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                },

                // Error recovery methods
                async reprocessDocument(documentId) {
                    try {
                        const response = await fetch(`/api/reprocess/${documentId}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            // Refresh the document list to show updated status
                            await this.loadDocuments(true);
                        } else {
                            const error = await response.text();
                            console.error('âŒ Failed to reprocess document:', error);
                            alert(`Failed to reprocess document: ${error}`);
                        }
                    } catch (error) {
                        console.error('âŒ Error reprocessing document:', error);
                        alert(`Error reprocessing document: ${error.message}`);
                    }
                },

                async analyzeDocument(documentId) {
                    try {
                        
                        // Find the document in our list
                        const doc = this.documents.find(d => d.id === documentId);
                        if (!doc) {
                            console.error('âŒ Document not found in list');
                            alert('Document not found in list');
                            return;
                        }
                        
                        // Select the document first
                        this.currentDocument = doc;
                        this.currentSession = null;
                        this.chatMessages = [];
                        
                        // Start analysis
                        await this.startAnalysis();
                    } catch (error) {
                        console.error('âŒ Error analyzing document:', error);
                        alert(`Error analyzing document: ${error.message}`);
                    }
                },

                async reuploadDocument(documentId) {
                    try {
                        
                        // For now, just show a message. In a full implementation,
                        // this would trigger a file upload dialog
                        if (confirm('Re-upload functionality will be implemented. For now, delete this document and upload it again?')) {
                            await this.deleteDocument(documentId);
                        }
                    } catch (error) {
                        console.error('âŒ Error re-uploading document:', error);
                        alert(`Error re-uploading document: ${error.message}`);
                    }
                },

                async exportResults() {
                    if (!this.currentSession) return;

                    try {
                        const response = await fetch(`/api/export/${this.currentSession.session_id}?format=json`);
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `contract-review-${this.currentDocument?.filename || 'document'}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (error) {
                        alert(`Error exporting: ${error.message}`);
                    }
                },

                // Document ID utilities
                async copyDocumentId(event) {
                    if (!this.currentDocument?.id) return;
                    
                    try {
                        await navigator.clipboard.writeText(this.currentDocument.id);
                        
                        // Show temporary success feedback
                        const button = event.target.closest('button');
                        const originalIcon = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check text-xs text-green-600"></i>';
                        button.classList.add('text-green-600');
                        
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                            button.classList.remove('text-green-600');
                        }, 2000);
                    } catch (error) {
                        console.error('Failed to copy document ID:', error);
                        alert('Failed to copy document ID to clipboard');
                    }
                },

                openDataInspector() {
                    if (!this.currentDocument?.id) return;
                    
                    // Open the Tri-Store Data Inspector in a new window with the current document ID
                    const inspectorUrl = `http://localhost:3000/inspector.html?doc_id=${encodeURIComponent(this.currentDocument.id)}`;
                    window.open(inspectorUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                },

                addComment() {
                    if (!this.newComment.trim()) return;

                    this.comments.push({
                        id: Date.now(),
                        text: this.newComment,
                        created_at: new Date()
                    });
                    this.newComment = '';
                },

                deleteComment(commentId) {
                    this.comments = this.comments.filter(c => c.id !== commentId);
                },

                // Log History Methods
                async loadDocumentLogs() {
                    if (!this.currentDocument?.id) return;
                    
                    this.loadingLogs = true;
                    this.logOffset = 0; // Reset pagination
                    
                    try {
                        const params = new URLSearchParams({
                            limit: this.logLimit.toString(),
                            offset: this.logOffset.toString()
                        });
                        
                        if (this.logLevelFilter) {
                            params.append('log_level', this.logLevelFilter);
                        }
                        
                        if (this.logSearchTerm) {
                            params.append('search_term', this.logSearchTerm);
                        }
                        
                        const response = await fetch(`/api/documents/${this.currentDocument.id}/logs?${params}`);
                        
                        if (response.ok) {
                            this.documentLogs = await response.json();
                        } else {
                            console.error('Failed to load document logs:', response.statusText);
                            this.documentLogs = { logs: [], pagination: { total_count: 0 } };
                        }
                    } catch (error) {
                        console.error('Error loading document logs:', error);
                        this.documentLogs = { logs: [], pagination: { total_count: 0 } };
                    } finally {
                        this.loadingLogs = false;
                    }
                },

                async loadMoreLogs() {
                    if (!this.currentDocument?.id || !this.documentLogs?.pagination?.has_more) return;
                    
                    this.loadingLogs = true;
                    this.logOffset += this.logLimit;
                    
                    try {
                        const params = new URLSearchParams({
                            limit: this.logLimit.toString(),
                            offset: this.logOffset.toString()
                        });
                        
                        if (this.logLevelFilter) {
                            params.append('log_level', this.logLevelFilter);
                        }
                        
                        if (this.logSearchTerm) {
                            params.append('search_term', this.logSearchTerm);
                        }
                        
                        const response = await fetch(`/api/documents/${this.currentDocument.id}/logs?${params}`);
                        
                        if (response.ok) {
                            const moreLogs = await response.json();
                            this.documentLogs.logs = [...this.documentLogs.logs, ...moreLogs.logs];
                            this.documentLogs.pagination = moreLogs.pagination;
                        } else {
                            console.error('Failed to load more logs:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error loading more logs:', error);
                    } finally {
                        this.loadingLogs = false;
                    }
                },

                debounceLoadLogs() {
                    if (this.logDebounceTimer) {
                        clearTimeout(this.logDebounceTimer);
                    }
                    
                    this.logDebounceTimer = setTimeout(() => {
                        this.loadDocumentLogs();
                    }, 500); // 500ms delay
                },

                async copyLogMessage(logMessage) {
                    try {
                        await navigator.clipboard.writeText(logMessage);
                        
                        // Show temporary success feedback
                        const button = event.target.closest('button');
                        const originalIcon = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check text-xs text-green-600"></i>';
                        
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                        }, 2000);
                    } catch (error) {
                        console.error('Failed to copy log message:', error);
                        alert('Failed to copy log message to clipboard');
                    }
                },

                 // Document Viewer Methods
                async loadDocumentContent() {
                    if (!this.currentDocument?.id) {
                        this.documentContent = '<p class="text-red-500">No document selected</p>';
                        return;
                    }

                    try {
                        this.documentContent = '<p class="text-blue-500">Loading document content...</p>';

                        if (this.currentSession?.document_text) {
                            this.documentContent = this.formatDocumentText(this.currentSession.document_text);
                            this.documentRenderKey++;
                        } else {
                            const response = await fetch(`/api/documents/${this.currentDocument.id}/content`);
                            if (response.ok) {
                                const data = await response.json();
                                const rawText = data?.content || '';
                                this.documentContent = this.formatDocumentText(rawText);
                                this.documentRenderKey++;
                            } else {
                                const errorText = await response.text();
                                this.documentContent = `<p class="text-gray-500">Document content not available (${response.status})</p>`;
                                this.documentRenderKey++;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading document content:', error);
                        this.documentContent = `<p class="text-red-500">Error loading document content: ${error.message}</p>`;
                    }
                },

                formatDocumentText(text) {
                    if (!text) return '<p class="text-gray-500">No content available</p>';

                    // Decode escaped HTML entities (e.g. &lt;p&gt;)
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = text;
                    let decoded = textarea.value;

                    // If still escaped (some double escaping), decode again
                    if (decoded.includes('&lt;') && decoded.includes('&gt;')) {
                        textarea.innerHTML = decoded;
                        decoded = textarea.value;
                    }

                    // Clean formatting and convert plain text line breaks to HTML
                    decoded = decoded
                        .replace(/\r/g, '')
                        .replace(/\\n/g, '\n')           // fix literal "\n"
                        .replace(/\n{2,}/g, '</p><p>')  // paragraph breaks
                        .replace(/\n/g, '<br>')         // single newlines
                        .replace(/^/, '<p>')
                        .replace(/$/, '</p>');

                    // Optional: apply highlighting helper
                    decoded = this.addHighlightingSpans(decoded);

                    return decoded;
                },

                addHighlightingSpans(text) {
                    // Add spans around potential section references for highlighting
                    return text
                        .replace(/(Section \d+\.?\d*)/gi, '<span class="highlight-section" data-section="$1">$1</span>')
                        .replace(/(Clause \d+\.?\d*)/gi, '<span class="highlight-clause" data-clause="$1">$1</span>')
                        .replace(/(Article \d+\.?\d*)/gi, '<span class="highlight-article" data-article="$1">$1</span>')
                        .replace(/(Page \d+)/gi, '<span class="highlight-page" data-page="$1">$1</span>');
                },

                highlightInDocument(item) {
                    if (!this.showHighlights) return;
                    
                    // Clear previous highlights
                    this.clearHighlights();
                    
                    // Get citation text to search for
                    let searchText = '';
                    if (typeof item === 'string') {
                        searchText = item;
                    } else if (item.citation) {
                        searchText = item.citation;
                    } else if (item.text_excerpt) {
                        searchText = item.text_excerpt;
                    } else if (item.point) {
                        searchText = item.point;
                    } else if (item.description) {
                        searchText = item.description;
                    }
                    
                    if (searchText) {
                        this.highlightTextInDocument(searchText);
                        this.scrollToHighlight();
                    }
                },

                highlightTextInDocument(searchText) {
                    const docContent = document.getElementById('document-content');
                    if (!docContent) return;
                    
                    // Create a regex to find the text (case insensitive)
                    const regex = new RegExp(`(${searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    
                    // Replace text with highlighted version
                    docContent.innerHTML = docContent.innerHTML.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
                    
                    this.highlightedText = searchText;
                },

                clearHighlights() {
                    const docContent = document.getElementById('document-content');
                    if (!docContent) return;
                    
                    // Remove all highlight marks
                    const marks = docContent.querySelectorAll('mark');
                    marks.forEach(mark => {
                        const parent = mark.parentNode;
                        parent.replaceChild(document.createTextNode(mark.textContent), mark);
                        parent.normalize();
                    });
                    
                    this.highlightedText = null;
                },

                scrollToHighlight() {
                    const docContent = document.getElementById('document-content');
                    if (!docContent) return;
                    
                    const firstHighlight = docContent.querySelector('mark');
                    if (firstHighlight) {
                        firstHighlight.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                },

                async downloadDocument() {
                    if (!this.currentDocument?.id) return;
                    
                    try {
                        const response = await fetch(`/api/documents/${this.currentDocument.id}/download`);
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = this.currentDocument.original_filename || 'document';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        } else {
                            alert('Failed to download document');
                        }
                    } catch (error) {
                        console.error('Error downloading document:', error);
                        alert('Error downloading document');
                    }
                },

                // Original File View Methods
                isPdfFile() {
                    const fileType = this.currentDocument?.file_type?.toLowerCase();
                    return fileType === '.pdf' || fileType === 'pdf';
                },

                async openOriginalInNewTab() {
                    if (!this.currentDocument?.id) return;
                    
                    try {
                        const response = await fetch(`/api/documents/${this.currentDocument.id}/download`);
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            
                            if (this.isPdfFile()) {
                                // For PDF files, open directly in browser
                                window.open(url, '_blank');
                            } else {
                                // For Word documents, show a helpful message and offer alternatives
                                const filename = this.currentDocument.original_filename || 'document';
                                
                                // Create a modal or alert with viewing options
                                const message = `
Word Document Viewing Options:

1. Download the file and open it with Microsoft Word or compatible software
2. Upload to Google Drive and view online
3. Use Microsoft Office Online (requires uploading the file)

Click OK to download the file, or Cancel to stay here.
                                `;
                                
                                if (confirm(message)) {
                                    // User chose to download
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                }
                            }
                            
                            // Clean up the URL after a delay
                            setTimeout(() => {
                                window.URL.revokeObjectURL(url);
                            }, 10000);
                        } else {
                            alert('Failed to open document');
                        }
                    } catch (error) {
                        console.error('Error opening document:', error);
                        alert('Error opening document');
                    }
                },

                formatFileSize(bytes) {
                    if (!bytes) return 'Unknown';
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                },

                formatDate(dateString) {
                    if (!dateString) return 'Unknown';
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (error) {
                        return 'Invalid date';
                    }
                },

                getRiskClass(level) {
                    const l = level?.toLowerCase();
                    if (l === 'low') return 'bg-green-100 text-green-800 border border-green-200';
                    if (l === 'medium') return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                    if (l === 'high') return 'bg-red-100 text-red-800 border border-red-200';
                    return 'bg-gray-100 text-gray-800 border border-gray-200';
                },

                formatFileSize(bytes) {
                    if (!bytes || bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                formatDate(date) {
                    if (!date) return 'Unknown';
                    const now = new Date();
                    const docDate = new Date(date);
                    const diffMs = now - docDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;
                    
                    return docDate.toLocaleDateString();
                },

                formatTime(date) {
                    return new Date(date).toLocaleTimeString();
                },

                formatSummary(text) {
                    if (!text) return '<p class="text-gray-500">No summary available. Click Analyze to start.</p>';
                    
                    // Convert **text** to bold
                    let formatted = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    
                    // Split by periods followed by space or double space to create paragraphs
                    // This helps break up the dense text
                    formatted = formatted.replace(/\.\s+\d+\.\s+/g, '.</p><p class="mb-3">');
                    
                    // Handle numbered lists (1. 2. 3.)
                    formatted = formatted.replace(/(\d+\.\s+<strong>[^<]+<\/strong>)/g, '</p><p class="mb-3 mt-4">$1');
                    
                    // Wrap in paragraph tags
                    formatted = '<p class="mb-3">' + formatted + '</p>';
                    
                    // Clean up any empty paragraphs
                    formatted = formatted.replace(/<p[^>]*>\s*<\/p>/g, '');
                    
                    return formatted;
                },

                formatKeyPoints(keyPoints) {
                    if (!keyPoints || !Array.isArray(keyPoints)) {
                        return '<p class="text-gray-500">No key points available. Click Analyze to start.</p>';
                    }
                    
                    let html = '<ul class="list-disc list-inside space-y-3">';
                    keyPoints.forEach(point => {
                        // Handle both old format (string) and new format (object with citations)
                        if (typeof point === 'string') {
                            // Old format - simple string
                            html += `<li class="text-gray-700">${point}</li>`;
                        } else if (typeof point === 'object' && point.point) {
                            // New format - object with citation
                            const importanceClass = point.importance === 'high' ? 'text-red-600 font-semibold' : 
                                                  point.importance === 'medium' ? 'text-orange-600 font-medium' : 
                                                  'text-gray-600';
                            
                            html += `<li class="text-gray-700 mb-2">
                                <div class="font-medium ${importanceClass}">${point.point}</div>
                                ${point.citation ? `<div class="text-sm text-blue-600 mt-1"><i class="fas fa-quote-left mr-1"></i>${point.citation}</div>` : ''}
                                ${point.text_excerpt ? `<div class="text-xs text-gray-500 mt-1 italic">"${point.text_excerpt}"</div>` : ''}
                            </li>`;
                        } else {
                            // Fallback for any other format
                            html += `<li class="text-gray-700">${JSON.stringify(point)}</li>`;
                        }
                    });
                    html += '</ul>';
                    
                    return html;
                },

                formatRecommendations(recommendations) {
                    if (!recommendations || !Array.isArray(recommendations)) {
                        return '<p class="text-gray-500">No recommendations available. Click Analyze to start.</p>';
                    }
                    
                    let html = '<ul class="list-disc list-inside space-y-3">';
                    recommendations.forEach(rec => {
                        // Handle both old format (string) and new format (object with citations)
                        if (typeof rec === 'string') {
                            // Old format - simple string
                            html += `<li class="text-gray-700">${rec}</li>`;
                        } else if (typeof rec === 'object' && rec.recommendation) {
                            // New format - object with citation
                            const priorityClass = rec.priority === 'high' ? 'text-red-600 font-semibold' : 
                                                rec.priority === 'medium' ? 'text-orange-600 font-medium' : 
                                                'text-gray-600';
                            
                            html += `<li class="text-gray-700 mb-2">
                                <div class="font-medium ${priorityClass}">${rec.recommendation}</div>
                                ${rec.rationale ? `<div class="text-sm text-gray-600 mt-1">${rec.rationale}</div>` : ''}
                                ${rec.citation ? `<div class="text-sm text-blue-600 mt-1"><i class="fas fa-quote-left mr-1"></i>${rec.citation}</div>` : ''}
                                ${rec.text_excerpt ? `<div class="text-xs text-gray-500 mt-1 italic">"${rec.text_excerpt}"</div>` : ''}
                            </li>`;
                        } else {
                            // Fallback for any other format
                            html += `<li class="text-gray-700">${JSON.stringify(rec)}</li>`;
                        }
                    });
                    html += '</ul>';
                    
                    return html;
                },

                // Settings methods
                async updateModel(type, modelId) {
                    try {
                        
                        if (type === 'llm') {
                            this.absFramework.selectedModel = modelId;
                            // TODO: Send API request to update LLM model
                        } else if (type === 'embedding') {
                            this.selectedEmbeddingModel = modelId;
                            // TODO: Send API request to update embedding model
                        }
                        
                        // Refresh vector status after model change
                        await this.refreshVectorStatus();
                    } catch (error) {
                        console.error(`âŒ Error updating ${type} model:`, error);
                    }
                },

                async refreshVectorStatus() {
                    try {
                        
                        // TODO: Make API call to get vector database status
                        // For now, simulate with a random count
                        this.vectorCount = Math.floor(Math.random() * 1000) + 500;
                        
                    } catch (error) {
                        console.error('âŒ Error refreshing vector status:', error);
                    }
                },

            }));
        });
    </script>
</body>
</html>