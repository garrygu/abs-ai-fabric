<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tri-Store Data Inspector - ABS Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div x-data="inspectorApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-search mr-2 text-blue-600"></i>Tri-Store Data Inspector
                        </h1>
                        <span class="ml-4 px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
                            ABS Hub Admin
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select x-model="env" class="border rounded px-3 py-1">
                            <option value="dev">Development</option>
                            <option value="staging">Staging</option>
                            <option value="prod">Production</option>
                        </select>
                        <button @click="checkHealth()" 
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            <i class="fas fa-heartbeat mr-2"></i>Health Check
                        </button>
                        <button @click="showBatchMode = !showBatchMode" 
                                class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                            <i class="fas fa-upload mr-2"></i>Batch Mode
                        </button>
                        <button @click="goBack()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Hub
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Health Status Banner -->
        <div x-show="health" class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center">
                        <i class="fas fa-database text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium">PostgreSQL:</span>
                        <span :class="health?.postgres?.status === 'healthy' ? 'text-green-600' : 'text-red-600'" 
                              class="ml-1 text-sm">
                            <i :class="health?.postgres?.status === 'healthy' ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                            <span x-text="health?.postgres?.status || 'Unknown'"></span>
                        </span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-memory text-red-600 mr-2"></i>
                        <span class="text-sm font-medium">Redis:</span>
                        <span :class="health?.redis?.status === 'healthy' ? 'text-green-600' : 'text-red-600'" 
                              class="ml-1 text-sm">
                            <i :class="health?.redis?.status === 'healthy' ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                            <span x-text="health?.redis?.status || 'Unknown'"></span>
                        </span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium">Qdrant:</span>
                        <span :class="health?.qdrant?.status === 'healthy' ? 'text-green-600' : 'text-red-600'" 
                              class="ml-1 text-sm">
                            <i :class="health?.qdrant?.status === 'healthy' ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                            <span x-text="health?.qdrant?.status || 'Unknown'"></span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Batch Mode Panel -->
            <div x-show="showBatchMode" class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-upload mr-2 text-purple-600"></i>Batch Processing Mode
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                        <input type="file" 
                               @change="handleFileUpload($event)" 
                               accept=".csv"
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                        <p class="text-xs text-gray-500 mt-1">CSV should have a 'doc_id' column with document IDs</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Or Enter Document IDs (one per line)</label>
                        <textarea x-model="batchDocIds" 
                                  placeholder="doc-123&#10;contract-456&#10;agreement-789"
                                  class="w-full border rounded px-3 py-2 h-24 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button @click="processBatch()" 
                                :disabled="!batchDocIds || batchLoading"
                                class="px-6 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 transition-colors">
                            <i class="fas fa-play mr-2"></i>
                            <span x-text="batchLoading ? 'Processing...' : 'Process Batch'"></span>
                        </button>
                        <button @click="exportBatchResults()" 
                                :disabled="!batchResults.length"
                                class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Results
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Form -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex gap-4">
                    <input x-model="docId" 
                           placeholder="Enter document ID (e.g., doc-123, contract-456)" 
                           class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           @keyup.enter="inspectDocument()">
                    <button @click="inspectDocument()" 
                            :disabled="!docId || loading"
                            class="px-6 py-2 bg-black text-white rounded hover:bg-gray-800 disabled:opacity-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        <span x-text="loading ? 'Inspecting...' : 'Inspect'"></span>
                    </button>
                    <button @click="analyzeVectors()" 
                            :disabled="!docId || vectorLoading"
                            class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 transition-colors">
                        <i class="fas fa-project-diagram mr-2"></i>
                        <span x-text="vectorLoading ? 'Analyzing...' : 'Vector Analysis'"></span>
                    </button>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Enter a document ID to inspect its data across PostgreSQL, Redis, and Qdrant stores
                    </div>
                    <div class="flex gap-2">
                        <button @click="exportResults('json')" 
                                :disabled="!result"
                                class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:opacity-50 transition-colors">
                            <i class="fas fa-download mr-1"></i>JSON
                        </button>
                        <button @click="exportResults('csv')" 
                                :disabled="!result"
                                class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 disabled:opacity-50 transition-colors">
                            <i class="fas fa-download mr-1"></i>CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vector Analysis Results -->
            <template x-if="vectorResult">
                <div class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-project-diagram mr-2 text-indigo-600"></i>Vector Neighborhood Analysis
                    </h3>
                    <div x-show="vectorResult?.error" class="text-red-600 mb-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span x-text="vectorResult?.error || ''"></span>
                    </div>
                    <div x-show="!vectorResult?.error">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-50 rounded p-4">
                                <div class="text-sm font-medium text-gray-600">Vector Dimensions</div>
                                <div class="text-lg font-semibold text-gray-900" x-text="vectorResult?.vector_dimensions ?? ''"></div>
                            </div>
                            <div class="bg-gray-50 rounded p-4">
                                <div class="text-sm font-medium text-gray-600">Neighbors Found</div>
                                <div class="text-lg font-semibold text-gray-900" x-text="vectorResult.analysis?.total_neighbors_found || 0"></div>
                            </div>
                            <div class="bg-gray-50 rounded p-4">
                                <div class="text-sm font-medium text-gray-600">In All Stores</div>
                                <div class="text-lg font-semibold text-gray-900" x-text="vectorResult.analysis?.neighbors_in_all_stores || 0"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-medium text-gray-700">Similar Documents:</h4>
                            <template x-for="neighbor in (vectorResult?.neighbors || [])" :key="neighbor.id">
                                <div class="border rounded p-3 hover:bg-gray-50">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium" x-text="neighbor.id"></div>
                                            <div class="text-sm text-gray-600">Similarity Score: <span x-text="neighbor.score?.toFixed(4)"></span></div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <span :class="neighbor?.stores?.postgres ? 'text-green-600' : 'text-red-600'" class="text-xs">
                                                <i :class="neighbor?.stores?.postgres ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>PG
                                            </span>
                                            <span :class="neighbor?.stores?.redis ? 'text-green-600' : 'text-red-600'" class="text-xs">
                                                <i :class="neighbor?.stores?.redis ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>Redis
                                            </span>
                                            <span :class="neighbor?.stores?.qdrant ? 'text-green-600' : 'text-red-600'" class="text-xs">
                                                <i :class="neighbor?.stores?.qdrant ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>Qdrant
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            </template>

            <!-- Batch Results -->
            <template x-if="batchResults?.length">
                <div class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-list mr-2 text-purple-600"></i>Batch Processing Results
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Document ID</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Status</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">PostgreSQL</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Redis</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Qdrant</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Issues</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="result in batchResults" :key="result.doc_id">
                                    <tr class="border-t hover:bg-gray-50">
                                        <td class="px-3 py-2 font-medium" x-text="result.doc_id"></td>
                                        <td class="px-3 py-2">
                                            <span :class="getStatusColor(result.consistency?.status || 'ERROR')" 
                                                  class="px-2 py-1 rounded text-xs">
                                                <span x-text="result.consistency?.status || 'ERROR'"></span>
                                            </span>
                                        </td>
                                        <td class="px-3 py-2">
                                            <i :class="result.postgres?.found ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                        </td>
                                        <td class="px-3 py-2">
                                            <i :class="result.redis?.found ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                        </td>
                                        <td class="px-3 py-2">
                                            <i :class="result.qdrant?.found ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                                        </td>
                                        <td class="px-3 py-2 text-xs" x-text="result.consistency?.problems?.length || 0"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </template>

            <!-- Results -->
            <template x-if="result">
                <div class="space-y-6">
                <!-- Consistency Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-balance-scale mr-2 text-blue-600"></i>Consistency Analysis
                    </h3>
                    <div class="flex items-center mb-4">
                        <span :class="getStatusColor(result?.consistency?.status || 'ERROR')" 
                              class="px-4 py-2 rounded-full text-sm font-medium">
                            <i :class="getStatusIcon(result?.consistency?.status || 'ERROR')" class="mr-2"></i>
                            <span x-text="result?.consistency?.status || 'ERROR'"></span>
                        </span>
                        <span class="ml-4 text-sm text-gray-600">
                            Found in: <span x-text="(result?.consistency?.found_stores || []).join(', ') || 'None'"></span>
                        </span>
                    </div>
                    
                    <!-- Problems -->
                    <div x-show="(result?.consistency?.problems || []).length > 0" class="mb-4">
                        <h4 class="font-medium text-red-600 mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Issues Found:
                        </h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <template x-for="problem in (result?.consistency?.problems || [])" :key="problem.code">
                                <li class="text-sm" x-text="problem.message"></li>
                            </template>
                        </ul>
                    </div>
                    
                    <!-- Field Differences -->
                    <div x-show="(result?.consistency?.field_diff || []).length > 0">
                        <h4 class="font-medium text-orange-600 mb-2 flex items-center">
                            <i class="fas fa-exchange-alt mr-2"></i>Field Differences:
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Field</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">PostgreSQL</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Redis</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Qdrant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="diff in (result?.consistency?.field_diff || [])" :key="diff.field">
                                        <tr class="border-t hover:bg-gray-50">
                                            <td class="px-3 py-2 font-medium" x-text="diff.field"></td>
                                            <td class="px-3 py-2" x-text="formatValue(diff.postgres)"></td>
                                            <td class="px-3 py-2" x-text="formatValue(diff.redis)"></td>
                                            <td class="px-3 py-2" x-text="formatValue(diff.qdrant)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Checksums -->
                    <div x-show="result?.consistency?.checksums && Object.keys(result?.consistency?.checksums || {}).length > 0" class="mt-4">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-fingerprint mr-2"></i>Data Checksums:
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <template x-for="(checksum, store) in (result?.consistency?.checksums || {})" :key="store">
                                <div class="bg-gray-50 rounded p-3">
                                    <div class="text-sm font-medium text-gray-600" x-text="store.charAt(0).toUpperCase() + store.slice(1)"></div>
                                    <div class="font-mono text-xs text-gray-800 mt-1" x-text="checksum"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Store Details -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- PostgreSQL -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-database text-blue-600 mr-2"></i>PostgreSQL
                        </h3>
                        <div x-show="result?.postgres">
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Status:</span>
                                    <span :class="result?.postgres?.found ? 'text-green-600' : 'text-red-600'">
                                        <i :class="result?.postgres?.found ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                        <span x-text="result?.postgres?.found ? 'Found' : 'Not Found'"></span>
                                    </span>
                                </div>
                                <div x-show="result?.postgres?.found" class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Key:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.postgres?.key || ''"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Checksum:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.postgres?.checksum || ''"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Updated:</span>
                                        <span class="text-xs" x-text="result?.postgres?.updated_at || 'N/A'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Redis -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-memory text-red-600 mr-2"></i>Redis
                        </h3>
                        <div x-show="result?.redis">
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Status:</span>
                                    <span :class="result?.redis?.found ? 'text-green-600' : 'text-red-600'">
                                        <i :class="result?.redis?.found ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                        <span x-text="result?.redis?.found ? 'Found' : 'Not Found'"></span>
                                    </span>
                                </div>
                                <div x-show="result?.redis?.found" class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Key:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.redis?.key || ''"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">TTL:</span>
                                        <span :class="(result?.redis?.ttl_seconds ?? 0) < 3600 ? 'text-orange-600 font-medium' : 'text-gray-600'">
                                            <span x-text="formatTTL(result?.redis?.ttl_seconds)"></span>
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Checksum:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.redis?.checksum || ''"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Qdrant -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-project-diagram text-purple-600 mr-2"></i>Qdrant
                        </h3>
                        <div x-show="result?.qdrant">
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Status:</span>
                                    <span :class="result?.qdrant?.found ? 'text-green-600' : 'text-red-600'">
                                        <i :class="result?.qdrant?.found ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                        <span x-text="result?.qdrant?.found ? 'Found' : 'Not Found'"></span>
                                    </span>
                                </div>
                                <div x-show="result?.qdrant?.found" class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Key:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.qdrant?.key || ''"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Checksum:</span>
                                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" x-text="result?.qdrant?.checksum || ''"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Updated:</span>
                                        <span class="text-xs" x-text="result?.qdrant?.updated_at || 'N/A'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Data (Collapsible) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <button @click="showRawData = !showRawData" 
                            class="flex items-center justify-between w-full text-left">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-code mr-2 text-gray-600"></i>Raw Data
                        </h3>
                        <i :class="showRawData ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="text-gray-400"></i>
                    </button>
                    <div x-show="showRawData" x-transition class="mt-4">
                        <pre class="bg-gray-50 rounded p-4 text-xs overflow-x-auto" x-text="JSON.stringify(result, null, 2)"></pre>
                    </div>
                </div>
            </div>
            </template>

            <!-- Loading State -->
            <div x-show="loading" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Inspecting document across all stores...</p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                    <div>
                        <h3 class="text-red-800 font-medium">Inspection Failed</h3>
                        <p class="text-red-700 text-sm mt-1" x-text="error"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function inspectorApp() {
            return {
                docId: '',
                env: 'prod',
                loading: false,
                vectorLoading: false,
                batchLoading: false,
                result: null,
                vectorResult: null,
                batchResults: [],
                batchDocIds: '',
                health: null,
                error: null,
                showRawData: false,
                showBatchMode: false,

                init() {
                    // Check for document ID in URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const docId = urlParams.get('doc_id');
                    if (docId) {
                        this.docId = docId;
                        // Auto-inspect the document
                        this.inspectDocument();
                    }
                },

                async inspectDocument() {
                    if (!this.docId.trim()) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.result = null;
                    
                    try {
                        // Call the gateway API (port 8081)
                        const response = await fetch(`http://localhost:8081/admin/inspector/${encodeURIComponent(this.docId)}?env=${this.env}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        this.result = await response.json();
                    } catch (error) {
                        console.error('Inspection failed:', error);
                        this.error = error.message || 'Failed to inspect document';
                    } finally {
                        this.loading = false;
                    }
                },

                async analyzeVectors() {
                    if (!this.docId.trim()) return;
                    
                    this.vectorLoading = true;
                    this.vectorResult = null;
                    
                    try {
                        const response = await fetch(`http://localhost:8081/admin/inspector/vectors/${encodeURIComponent(this.docId)}?env=${this.env}&limit=5`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        this.vectorResult = await response.json();
                    } catch (error) {
                        console.error('Vector analysis failed:', error);
                        this.vectorResult = { error: error.message || 'Failed to analyze vectors' };
                    } finally {
                        this.vectorLoading = false;
                    }
                },

                async processBatch() {
                    if (!this.batchDocIds.trim()) return;
                    
                    this.batchLoading = true;
                    this.batchResults = [];
                    
                    try {
                        const docIds = this.batchDocIds.split('\n').map(id => id.trim()).filter(id => id);
                        
                        const response = await fetch('http://localhost:8081/admin/inspector/batch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                doc_ids: docIds,
                                env: this.env
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        this.batchResults = data.results || [];
                    } catch (error) {
                        console.error('Batch processing failed:', error);
                        alert('Batch processing failed: ' + error.message);
                    } finally {
                        this.batchLoading = false;
                    }
                },

                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const docIds = [];
                        
                        // Simple CSV parsing - assumes first column is doc_id
                        for (let i = 1; i < lines.length; i++) { // Skip header
                            const line = lines[i].trim();
                            if (line) {
                                const docId = line.split(',')[0].trim().replace(/"/g, '');
                                if (docId) docIds.push(docId);
                            }
                        }
                        
                        this.batchDocIds = docIds.join('\n');
                    };
                    reader.readAsText(file);
                },

                async exportResults(format) {
                    if (!this.result) return;
                    
                    try {
                        const response = await fetch(`http://localhost:8081/admin/inspector/export/${encodeURIComponent(this.docId)}?format=${format}&env=${this.env}`);
                        if (!response.ok) {
                            throw new Error(`Export failed: ${response.statusText}`);
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `inspection_${this.docId}.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error('Export failed:', error);
                        alert('Export failed: ' + error.message);
                    }
                },

                async exportBatchResults() {
                    if (!this.batchResults.length) return;
                    
                    try {
                        const docIds = this.batchDocIds.split('\n').map(id => id.trim()).filter(id => id);
                        
                        const response = await fetch(`http://localhost:8081/admin/inspector/export/batch?format=csv`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                doc_ids: docIds,
                                env: this.env
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Export failed: ${response.statusText}`);
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `batch_inspection_${docIds.length}_docs.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error('Batch export failed:', error);
                        alert('Batch export failed: ' + error.message);
                    }
                },

                async checkHealth() {
                    try {
                        // Call the gateway health API (port 8081)
                        const response = await fetch('http://localhost:8081/admin/inspector/health');
                        this.health = await response.json();
                        console.log('Health check:', this.health);
                    } catch (error) {
                        console.error('Health check failed:', error);
                    }
                },

                goBack() {
                    window.location.href = '/';
                },

                getStatusColor(status) {
                    const colors = {
                        'OK': 'bg-green-100 text-green-800',
                        'WARNING': 'bg-yellow-100 text-yellow-800',
                        'ERROR': 'bg-red-100 text-red-800'
                    };
                    return colors[status] || 'bg-gray-100 text-gray-800';
                },

                getStatusIcon(status) {
                    const icons = {
                        'OK': 'fas fa-check-circle',
                        'WARNING': 'fas fa-exclamation-triangle',
                        'ERROR': 'fas fa-times-circle'
                    };
                    return icons[status] || 'fas fa-question-circle';
                },

                formatValue(value) {
                    if (value === null || value === undefined) return '-';
                    if (typeof value === 'object') return JSON.stringify(value);
                    return String(value);
                },

                formatTTL(seconds) {
                    if (seconds === null || seconds === undefined) return 'No TTL';
                    if (seconds === -1) return 'No expiration';
                    if (seconds < 60) return `${seconds}s`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
                    return `${Math.floor(seconds / 3600)}h`;
                }
            }
        }
    </script>
</body>
</html>
