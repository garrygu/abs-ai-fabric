<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Store - ABS AI Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }
        
        .app-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .app-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="appStore()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-2xl font-bold text-gray-900">üõçÔ∏è App Store</h1>
                        
                        <!-- Main Tabs -->
                        <nav class="flex space-x-1">
                            <a href="index.html" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition">
                                üß© My Assets
                            </a>
                            <a href="app-store.html" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md">
                                üõçÔ∏è App Store
                            </a>
                        </nav>
                    </div>
                    
                    <!-- Search -->
                    <div class="flex-1 max-w-md ml-8">
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="searchQuery"
                                @input.debounce.300ms="filterApps()"
                                placeholder="Search apps..." 
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sub Navigation -->
        <div class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-1 py-3">
                    <button 
                        @click="selectedSource = 'abs-official'; filterApps()"
                        :class="selectedSource === 'abs-official' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'"
                        class="px-4 py-2 rounded-md text-sm transition"
                    >
                        Official Store
                    </button>
                    <button 
                        @click="selectedSource = 'self-developed'; filterApps()"
                        :class="selectedSource === 'self-developed' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'"
                        class="px-4 py-2 rounded-md text-sm transition"
                    >
                        My Apps
                    </button>
                    <button 
                        @click="selectedSource = null; filterApps()"
                        :class="selectedSource === null ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100'"
                        class="px-4 py-2 rounded-md text-sm transition"
                    >
                        All
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Loading State -->
            <div x-show="loading" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Loading apps...</p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                    <p class="text-red-800" x-text="error"></p>
                </div>
            </div>

            <!-- Apps Grid -->
            <div x-show="!loading && !error" class="space-y-8">
                <!-- Categories -->
                <template x-for="category in categories" :key="category">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-4" x-text="getCategoryIcon(category) + ' ' + category"></h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <template x-for="app in getAppsByCategory(category)" :key="app.id">
                                <div class="app-card bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <!-- App Icon & Badges -->
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <i :class="app.icon || 'fas fa-cube'" class="text-2xl text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-gray-900" x-text="app.name"></h3>
                                                <div class="flex items-center space-x-2 mt-1">
                                                    <template x-if="app.metadata?.installed">
                                                        <span class="badge bg-green-100 text-green-700">
                                                            <i class="fas fa-check-circle mr-1"></i> Installed
                                                        </span>
                                                    </template>
                                                    <template x-if="app.metadata?.source_type === 'abs-official'">
                                                        <span class="badge bg-blue-100 text-blue-700">
                                                            <i class="fas fa-check-circle mr-1"></i> Verified
                                                        </span>
                                                    </template>
                                                    <template x-if="app.metadata?.source_type === 'self-developed'">
                                                        <span class="badge bg-purple-100 text-purple-700">
                                                            <i class="fas fa-code mr-1"></i> Self-Developed
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Description -->
                                    <p class="text-sm text-gray-600 mb-4 line-clamp-2" x-text="app.description || 'No description available'"></p>

                                    <!-- Metadata -->
                                    <div class="flex items-center space-x-4 text-xs text-gray-500 mb-4">
                                        <span x-text="'v' + (app.version || '1.0.0')"></span>
                                        <span x-text="app.category || 'General'"></span>
                                    </div>

                                    <!-- Actions -->
                                    <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                                        <button 
                                            @click="showAppDetails(app)"
                                            class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                                        >
                                            Details
                                        </button>
                                        <template x-if="!app.metadata?.installed">
                                            <button 
                                                @click="installApp(app.id)"
                                                :disabled="installing === app.id"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition"
                                            >
                                                <template x-if="installing === app.id">
                                                    <i class="fas fa-spinner fa-spin mr-2"></i> Installing...
                                                </template>
                                                <template x-if="installing !== app.id">
                                                    Install
                                                </template>
                                            </button>
                                        </template>
                                        <template x-if="app.metadata?.installed">
                                            <button 
                                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium transition"
                                            >
                                                Open
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredApps.length === 0 && !loading" class="text-center py-12">
                    <i class="fas fa-box-open text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">No apps found</p>
                </div>
            </div>

            <!-- Recommendations -->
            <div x-show="!loading && !error && recommendations.length > 0" class="mt-12">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üí° Recommended for You</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="app in recommendations" :key="app.id">
                        <div class="app-card bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <!-- Similar content to app cards above -->
                            <h3 class="font-semibold text-gray-900 mb-2" x-text="app.name"></h3>
                            <p class="text-sm text-gray-600 mb-4" x-text="app.description"></p>
                            <button 
                                @click="installApp(app.id)"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                            >
                                Install
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </main>

        <!-- App Detail Modal -->
        <div x-show="showModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click.self="showModal = false">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900" x-text="selectedApp?.name"></h2>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6" x-show="selectedApp">
                    <!-- App Details Content -->
                    <div class="grid grid-cols-3 gap-6">
                        <!-- Left: Icon & Basic Info -->
                        <div>
                            <div class="w-24 h-24 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                                <i :class="selectedApp?.icon || 'fas fa-cube'" class="text-4xl text-blue-600"></i>
                            </div>
                            <div class="space-y-2">
                                <p class="text-sm text-gray-600">Version: <span class="font-medium" x-text="selectedApp?.version"></span></p>
                                <p class="text-sm text-gray-600">Author: <span class="font-medium" x-text="selectedApp?.author || 'Unknown'"></span></p>
                                <p class="text-sm text-gray-600">Category: <span class="font-medium" x-text="selectedApp?.category"></span></p>
                            </div>
                        </div>
                        
                        <!-- Center: Description & Details -->
                        <div class="col-span-2">
                            <h3 class="font-semibold text-gray-900 mb-2">Description</h3>
                            <p class="text-gray-600 mb-6" x-text="selectedApp?.description"></p>
                            
                            <h3 class="font-semibold text-gray-900 mb-2">Requirements</h3>
                            <div class="space-y-2 mb-6">
                                <template x-for="service in selectedApp?.requirements?.services || []" :key="service">
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        <span x-text="service"></span>
                                    </div>
                                </template>
                            </div>
                            
                            <button 
                                @click="installApp(selectedApp?.id)"
                                :disabled="installing === selectedApp?.id || selectedApp?.metadata?.installed"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                            >
                                <template x-if="installing === selectedApp?.id">
                                    <i class="fas fa-spinner fa-spin mr-2"></i> Installing...
                                </template>
                                <template x-if="installing !== selectedApp?.id && !selectedApp?.metadata?.installed">
                                    Install
                                </template>
                                <template x-if="selectedApp?.metadata?.installed">
                                    Already Installed
                                </template>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function appStore() {
            return {
                apps: [],
                filteredApps: [],
                categories: [],
                selectedSource: null,
                searchQuery: '',
                loading: true,
                error: null,
                showModal: false,
                selectedApp: null,
                installing: null,
                recommendations: [],
                
                async init() {
                    await this.loadApps();
                },
                
                async loadApps() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const gatewayUrl = 'http://localhost:8081';
                        const params = new URLSearchParams();
                        if (this.selectedSource) {
                            params.append('source', this.selectedSource);
                        }
                        
                        const response = await fetch(`${gatewayUrl}/api/store/apps?${params}`);
                        if (!response.ok) throw new Error('Failed to load apps');
                        
                        const data = await response.json();
                        this.apps = data.apps || [];
                        this.categories = data.categories || [];
                        
                        this.filterApps();
                    } catch (error) {
                        this.error = error.message;
                        console.error('Error loading apps:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                filterApps() {
                    let filtered = [...this.apps];
                    
                    // Filter by source
                    if (this.selectedSource) {
                        filtered = filtered.filter(app => 
                            app.metadata?.source_type === this.selectedSource
                        );
                    }
                    
                    // Filter by search
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(app =>
                            app.name.toLowerCase().includes(query) ||
                            app.description.toLowerCase().includes(query) ||
                            (app.keywords || []).some(k => k.toLowerCase().includes(query))
                        );
                    }
                    
                    this.filteredApps = filtered;
                },
                
                getAppsByCategory(category) {
                    return this.filteredApps.filter(app => app.category === category);
                },
                
                getCategoryIcon(category) {
                    const icons = {
                        'Legal Apps': '‚öñÔ∏è',
                        'AI Tools': 'ü§ñ',
                        'Utility Services': 'üîß',
                        'General': 'üì¶'
                    };
                    return icons[category] || 'üì¶';
                },
                
                showAppDetails(app) {
                    this.selectedApp = app;
                    this.showModal = true;
                },
                
                async installApp(appId) {
                    if (this.installing) return;
                    
                    this.installing = appId;
                    try {
                        const gatewayUrl = 'http://localhost:8081';
                        const response = await fetch(`${gatewayUrl}/api/store/apps/${appId}/install`, {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Installation failed');
                        }
                        
                        const result = await response.json();
                        alert(`App installed successfully! ${result.message}`);
                        
                        // Reload apps to update installed status
                        await this.loadApps();
                    } catch (error) {
                        alert(`Failed to install app: ${error.message}`);
                        console.error('Installation error:', error);
                    } finally {
                        this.installing = null;
                    }
                }
            }
        }
    </script>
</body>
</html>



