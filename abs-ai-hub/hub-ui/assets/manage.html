<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Management - ABS AI Hub</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .asset-section {
            margin-bottom: 40px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .section-header:hover {
            background: rgba(102, 126, 234, 0.15);
        }
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-icon {
            font-size: 1.2rem;
        }
        .section-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .section-toggle {
            font-size: 1.5rem;
            color: #667eea;
            transition: transform 0.3s ease;
        }
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .section-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .section-content.collapsed {
            max-height: 0;
            margin: 0;
            opacity: 0;
        }
        .asset-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .asset-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
            color: #2c3e50;
        }
        .asset-class {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .asset-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .asset-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .meta-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px;
            border-radius: 6px;
        }
        .meta-label {
            font-weight: 600;
            color: #667eea;
        }
        .meta-value {
            color: #2c3e50;
        }
        .asset-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .policy-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .policy-title {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .policy-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .policy-tag {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close:hover {
            color: #667eea;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        .lifecycle-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .lifecycle-running {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        .lifecycle-stopped {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .lifecycle-paused {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Asset Management</h1>
            <div>
                <button class="btn" onclick="openAddModal()">Add Asset</button>
                <a href="index.html" class="btn btn-secondary">Back to Hub</a>
            </div>
        </div>

        <div id="loading" class="loading">
            <h3>Loading assets...</h3>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="assets-container" style="display: none;"></div>
    </div>

    <!-- Add/Edit Asset Modal -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Asset</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="assetForm">
                <div class="form-group">
                    <label class="form-label" for="assetId">Asset ID *</label>
                    <input type="text" id="assetId" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="assetName">Name *</label>
                    <input type="text" id="assetName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="assetClass">Class *</label>
                    <select id="assetClass" class="form-select" required>
                        <option value="">Select class...</option>
                        <option value="app">App</option>
                        <option value="service">Service</option>
                        <option value="model">Model</option>
                        <option value="tool">Tool</option>
                        <option value="dataset">Dataset</option>
                        <option value="secret">Secret</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="assetDescription">Description</label>
                    <textarea id="assetDescription" class="form-input form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="assetUrl">URL</label>
                    <input type="url" id="assetUrl" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label" for="allowedModels">Allowed Models (comma-separated)</label>
                    <input type="text" id="allowedModels" class="form-input" placeholder="llama3.2:latest, llama3.2:7b">
                </div>
                <div class="form-group">
                    <label class="form-label" for="allowedEmbeddings">Allowed Embeddings (comma-separated)</label>
                    <input type="text" id="allowedEmbeddings" class="form-input" placeholder="bge-small-en-v1.5, legal-bert">
                </div>
                <div class="form-group">
                    <label class="form-label" for="defaultChatModel">Default Chat Model</label>
                    <input type="text" id="defaultChatModel" class="form-input" placeholder="llama3.2:latest">
                </div>
                <div class="form-group">
                    <label class="form-label" for="defaultEmbedModel">Default Embedding Model</label>
                    <input type="text" id="defaultEmbedModel" class="form-input" placeholder="legal-bert">
                </div>
                <div class="form-group">
                    <label class="form-label" for="defaultProvider">Default Provider</label>
                    <select id="defaultProvider" class="form-select">
                        <option value="">Select provider...</option>
                        <option value="auto">Auto</option>
                        <option value="ollama">Ollama</option>
                        <option value="openai">OpenAI/vLLM</option>
                        <option value="huggingface">Hugging Face</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="embeddingDim">Embedding Dimension</label>
                    <input type="number" id="embeddingDim" class="form-input" placeholder="384">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save Asset</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const GATEWAY_URL = 'http://localhost:8081';
        let currentAssets = [];
        let editingAsset = null;

        // Load assets on page load
        document.addEventListener('DOMContentLoaded', loadAssets);

        async function loadAssets() {
            try {
                const response = await fetch(`${GATEWAY_URL}/assets`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                currentAssets = await response.json();
                renderAssets();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('assets-container').style.display = 'grid';
            } catch (error) {
                showError(`Failed to load assets: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderAssets() {
            const container = document.getElementById('assets-container');
            
            // Group assets by class
            const groupedAssets = currentAssets.reduce((groups, asset) => {
                const className = asset.class || 'other';
                if (!groups[className]) {
                    groups[className] = [];
                }
                groups[className].push(asset);
                return groups;
            }, {});

            // Define section metadata
            const sectionConfig = {
                'app': { icon: 'ðŸ“±', title: 'Applications', color: '#667eea' },
                'service': { icon: 'âš™ï¸', title: 'Services', color: '#28a745' },
                'model': { icon: 'ðŸ§ ', title: 'Models', color: '#ffc107' },
                'tool': { icon: 'ðŸ”§', title: 'Tools', color: '#17a2b8' },
                'dataset': { icon: 'ðŸ“Š', title: 'Datasets', color: '#6f42c1' },
                'secret': { icon: 'ðŸ”', title: 'Secrets', color: '#dc3545' },
                'other': { icon: 'ðŸ“¦', title: 'Other', color: '#6c757d' }
            };

            // Render sections
            container.innerHTML = Object.keys(groupedAssets).map(className => {
                const assets = groupedAssets[className];
                const config = sectionConfig[className] || sectionConfig['other'];
                
                return `
                    <div class="asset-section">
                        <div class="section-header" onclick="toggleSection('${className}')">
                            <h2 class="section-title">
                                <span class="section-icon">${config.icon}</span>
                                ${config.title}
                                <span class="section-count">${assets.length}</span>
                            </h2>
                            <span class="section-toggle" id="toggle-${className}">â–¼</span>
                        </div>
                        <div class="section-content" id="content-${className}">
                            ${assets.map(asset => renderAssetCard(asset)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAssetCard(asset) {
            return `
                <div class="asset-card">
                    <div class="asset-header">
                        <h3 class="asset-title">${asset.name}</h3>
                        <span class="asset-class">${asset.class}</span>
                    </div>
                    <div class="asset-description">${asset.description || 'No description'}</div>
                    <div class="asset-meta">
                        <div class="meta-item">
                            <div class="meta-label">ID</div>
                            <div class="meta-value">${asset.id}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">URL</div>
                            <div class="meta-value">${asset.metadata?.url || 'N/A'}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Lifecycle</div>
                            <div class="meta-value">
                                <span class="lifecycle-badge lifecycle-${asset.lifecycle?.desired || 'stopped'}">
                                    ${asset.lifecycle?.desired || 'stopped'}
                                </span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Owner</div>
                            <div class="meta-value">${asset.owner || 'N/A'}</div>
                        </div>
                    </div>
                    ${asset.policy ? `
                        <div class="policy-section">
                            <div class="policy-title">Policy</div>
                            <div class="policy-items">
                                ${asset.policy.allowed_models ? asset.policy.allowed_models.map(m => 
                                    `<span class="policy-tag">${m}</span>`
                                ).join('') : ''}
                                ${asset.policy.allowed_embeddings ? asset.policy.allowed_embeddings.map(e => 
                                    `<span class="policy-tag">${e}</span>`
                                ).join('') : ''}
                            </div>
                        </div>
                    ` : ''}
                    <div class="asset-actions">
                        <button class="btn btn-small" onclick="editAsset('${asset.id}')">Edit</button>
                        <button class="btn btn-small btn-success" onclick="setLifecycle('${asset.id}', 'running')">Enable</button>
                        <button class="btn btn-small btn-secondary" onclick="setLifecycle('${asset.id}', 'stopped')">Disable</button>
                        <button class="btn btn-small btn-danger" onclick="deleteAsset('${asset.id}')">Delete</button>
                    </div>
                </div>
            `;
        }

        function toggleSection(className) {
            const content = document.getElementById(`content-${className}`);
            const toggle = document.getElementById(`toggle-${className}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        function openAddModal() {
            editingAsset = null;
            document.getElementById('modalTitle').textContent = 'Add Asset';
            document.getElementById('assetForm').reset();
            document.getElementById('assetModal').style.display = 'block';
        }

        function editAsset(assetId) {
            const asset = currentAssets.find(a => a.id === assetId);
            if (!asset) return;

            editingAsset = asset;
            document.getElementById('modalTitle').textContent = 'Edit Asset';
            document.getElementById('assetId').value = asset.id;
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetClass').value = asset.class;
            document.getElementById('assetDescription').value = asset.description || '';
            document.getElementById('assetUrl').value = asset.metadata?.url || '';
            document.getElementById('allowedModels').value = asset.policy?.allowed_models?.join(', ') || '';
            document.getElementById('allowedEmbeddings').value = asset.policy?.allowed_embeddings?.join(', ') || '';
            document.getElementById('defaultChatModel').value = asset.policy?.defaults?.chat_model || '';
            document.getElementById('defaultEmbedModel').value = asset.policy?.defaults?.embed_model || '';
            document.getElementById('defaultProvider').value = asset.policy?.defaults?.provider || '';
            document.getElementById('embeddingDim').value = asset.policy?.defaults?.dim || '';
            document.getElementById('assetModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('assetModal').style.display = 'none';
            editingAsset = null;
        }

        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('assetId').value,
                class: document.getElementById('assetClass').value,
                name: document.getElementById('assetName').value,
                description: document.getElementById('assetDescription').value,
                metadata: {
                    url: document.getElementById('assetUrl').value
                },
                policy: {}
            };

            // Parse policy fields
            const allowedModels = document.getElementById('allowedModels').value
                .split(',').map(s => s.trim()).filter(s => s);
            const allowedEmbeddings = document.getElementById('allowedEmbeddings').value
                .split(',').map(s => s.trim()).filter(s => s);

            if (allowedModels.length > 0) formData.policy.allowed_models = allowedModels;
            if (allowedEmbeddings.length > 0) formData.policy.allowed_embeddings = allowedEmbeddings;

            // Add defaults if provided
            const defaults = {};
            const defaultChatModel = document.getElementById('defaultChatModel').value.trim();
            const defaultEmbedModel = document.getElementById('defaultEmbedModel').value.trim();
            const defaultProvider = document.getElementById('defaultProvider').value.trim();
            const embeddingDim = document.getElementById('embeddingDim').value.trim();

            if (defaultChatModel) defaults.chat_model = defaultChatModel;
            if (defaultEmbedModel) defaults.embed_model = defaultEmbedModel;
            if (defaultProvider) defaults.provider = defaultProvider;
            if (embeddingDim) defaults.dim = parseInt(embeddingDim);

            if (Object.keys(defaults).length > 0) {
                formData.policy.defaults = defaults;
            }

            try {
                let response;
                if (editingAsset) {
                    response = await fetch(`${GATEWAY_URL}/admin/assets/${editingAsset.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${GATEWAY_URL}/admin/assets`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                showSuccess(editingAsset ? 'Asset updated successfully' : 'Asset created successfully');
                closeModal();
                loadAssets();
            } catch (error) {
                showError(`Failed to save asset: ${error.message}`);
            }
        });

        async function setLifecycle(assetId, desired) {
            try {
                const response = await fetch(`${GATEWAY_URL}/admin/assets/${assetId}/lifecycle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ desired })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                showSuccess(`Asset ${desired} successfully`);
                loadAssets();
            } catch (error) {
                showError(`Failed to update lifecycle: ${error.message}`);
            }
        }

        async function deleteAsset(assetId) {
            if (!confirm(`Are you sure you want to delete asset "${assetId}"?`)) return;

            try {
                const response = await fetch(`${GATEWAY_URL}/admin/assets/${assetId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                showSuccess('Asset deleted successfully');
                loadAssets();
            } catch (error) {
                showError(`Failed to delete asset: ${error.message}`);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('assetModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
